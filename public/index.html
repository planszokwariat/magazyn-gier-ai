<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magazyn Gier Planszowych v3.12 (ERP)</title>
    <style>
        /*
        ================================================================================
        STYLES (CSS) - MODERN DASHBOARD & UI
        ================================================================================
        */
        :root {
            --color-bg: #121212;
            --color-text: #ffffff;
            --color-text-muted: #aaaaaa;
            --color-accent: #00bcd4;
            --color-accent-hover: #26c6da;
            --color-surface: #1e1e1e;
            --color-surface-light: #2d2d2d;
            --color-border: #444;
            --color-success: #4CAF50;
            --color-danger: #ff5252;
            --color-warning: #ffb74d;
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --spacing-unit: 8px;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--color-bg);
            color: var(--color-text);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        * { box-sizing: border-box; }

        /* FORMS */
        input, select, textarea {
            padding: 0.7rem;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            background-color: var(--color-surface-light) !important;
            color: #ffffff !important;
            width: 100%;
            margin-bottom: 5px;
            font-size: 1rem;
            min-height: 40px;
        }
        input:focus, select:focus { outline: 2px solid var(--color-accent); background-color: #404040 !important; }
        
        select {
            appearance: auto !important; cursor: pointer;
            background-image: none !important; padding-right: 0 !important;
        }
        option { background-color: var(--color-surface); color: white; padding: 5px; }

        /* BUTTONS */
        button {
            padding: 0.6rem 1.2rem; border: none; border-radius: 4px; cursor: pointer;
            font-weight: bold; transition: 0.2s; white-space: nowrap; margin-right: 5px; font-size: 0.9rem;
        }
        .btn-primary { background-color: var(--color-accent); color: #000; }
        .btn-primary:hover { background-color: var(--color-accent-hover); }
        .btn-danger { background-color: var(--color-danger); color: white; }
        .btn-danger:hover { background-color: #ff1744; }
        .btn-success { background-color: var(--color-success); color: white; }
        .btn-warning { background-color: var(--color-warning); color: #000; }
        .btn-secondary { background-color: #555; color: white; }
        .btn-secondary:hover { background-color: #666; }
        
        .input-group { display: flex; gap: 5px; align-items: flex-start; }
        .input-group select { flex-grow: 1; }
        .btn-add-inline { padding: 0 12px; height: 40px; background-color: var(--color-success); color: white; font-size: 1.2rem; line-height: 1; margin: 0; }
        .btn-sm { padding: 0.3rem 0.6rem; font-size: 0.8rem; }
        .btn-delete-icon { padding: 0.3rem 0.6rem; background-color: transparent; border: 1px solid var(--color-danger); color: var(--color-danger); }
        .btn-delete-icon:hover { background-color: var(--color-danger); color: white; }

        /* LAYOUT */
        .topbar {
            display: flex; align-items: center; padding: 16px;
            background-color: var(--color-surface); border-bottom: 1px solid var(--color-border);
            flex-wrap: wrap; gap: 10px; position: sticky; top: 0; z-index: 100;
        }
        .topbar h1 { margin: 0; font-size: 1.4rem; color: var(--color-accent); flex-grow: 1; text-shadow: 0 0 5px rgba(0,255,255,0.2); }

        .main-content { padding: 20px; flex-grow: 1; }
        .panel { background-color: var(--color-surface); border-radius: 8px; padding: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }

        /* TABS */
        .tabs { display: flex; border-bottom: 2px solid var(--color-border); margin-bottom: 20px; overflow-x: auto;}
        .tab-button {
            background: none; border: none; padding: 12px 20px; color: var(--color-text-muted);
            font-weight: bold; cursor: pointer; border-bottom: 3px solid transparent; font-size: 1rem;
        }
        .tab-button:hover { color: white; background-color: rgba(255,255,255,0.05); }
        .tab-button.active { color: var(--color-accent); border-bottom: 3px solid var(--color-accent); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* TABLES */
        .table-container { overflow-x: auto; max-height: 70vh; border: 1px solid var(--color-border); border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #333; vertical-align: middle; color: white; }
        th { 
            background-color: #252525; color: var(--color-accent); font-size: 0.9rem; 
            position: sticky; top: 0; z-index: 10; font-weight: bold; 
            text-transform: uppercase; letter-spacing: 0.5px; 
            cursor: pointer; user-select: none; /* Add cursor for sorting */
        }
        th:hover { background-color: #333; } /* Hover effect for headers */
        th::after { content: ' ‚áÖ'; font-size: 0.8em; opacity: 0.3; margin-left: 5px; } /* Sort icon */
        th.sort-asc::after { content: ' ‚ñ≤'; opacity: 1; color: var(--color-success); }
        th.sort-desc::after { content: ' ‚ñº'; opacity: 1; color: var(--color-danger); }

        tr:hover { background-color: #333; }
        .numeric { text-align: right; }

        /* SETTINGS LIST */
        .settings-list { list-style: none; padding: 0; max-height: 400px; overflow-y: auto; border: 1px solid var(--color-border); border-radius: 4px; }
        .settings-list li { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #333; background-color: var(--color-surface-light); }
        .settings-list li:hover { background-color: #404040; }

        /* MODALS */
        dialog.modal {
            margin: auto; background-color: var(--color-surface); color: var(--color-text);
            border: 1px solid var(--color-border); border-radius: 8px; padding: 0;
            width: 95%; max-width: 1100px; max-height: 90vh;
            box-shadow: 0 0 50px rgba(0,0,0,0.9); z-index: 10000;
        }
        dialog.modal:not([open]) { display: none; }
        dialog.modal::backdrop { background: rgba(0,0,0,0.85); backdrop-filter: blur(4px); }
        .modal-content { background-color: transparent; padding: 25px; width: 100%; overflow-y: auto; max-height: 85vh; }

        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 5px; color: var(--color-accent); font-size: 0.9rem; font-weight: bold; }
        .section-header { border-bottom: 1px solid var(--color-border); padding-bottom: 5px; margin: 20px 0 10px 0; color: #FFD700; font-size: 1.1rem; }
        .actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .batch-summary { background: #222; padding: 15px; border-radius: 4px; margin-top: 15px; display: flex; justify-content: space-between; font-weight: bold; border: 1px solid var(--color-border); color: white; }

        /* --- STATS DASHBOARD FIXED --- */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); /* WYMUSZENIE 2 KOLUMN */
            gap: 20px; 
            margin-bottom: 30px; 
        }

        .ranking-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* WYMUSZENIE 2 KOLUMN */
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card { 
            background-color: var(--color-surface-light); padding: 20px; border-radius: 8px; 
            border-left: 4px solid var(--color-accent); box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
            display: flex; flex-direction: column; justify-content: space-between;
            height: 100%; /* Wymuszenie r√≥wnej wysoko≈õci */
        }
        
        /* Klasa dla kafelk√≥w rankingu, ≈ºeby wyglƒÖda≈Çy sp√≥jnie */
        .ranking-card {
            background-color: var(--color-surface-light);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #333;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .stat-card.collection { border-left-color: #9C27B0; }
        .stat-card.profit { border-left-color: #4CAF50; }
        .stat-card.cost { border-left-color: #F44336; }
        .stat-card.value-card { border-left-color: #FFD700; }
        .stat-card.margin-card { border-left-color: #4CAF50; }
        .stat-card.time-card { border-left-color: #2196F3; }
        
        .stat-card h3 { margin: 0 0 10px 0; color: var(--color-text-muted); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; }
        .stat-card .value { font-size: 1.6rem; font-weight: bold; color: white; }
        .stat-card .subtext { font-size: 0.85rem; color: #888; margin-top: 5px; }

        .stats-section-title { font-size: 1.2rem; color: var(--color-accent); margin: 30px 0 15px 0; border-bottom: 1px solid #333; padding-bottom: 5px; }
        
        /* TOP TABLE FIXED */
        .top-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; table-layout: fixed; }
        .top-table th { background: #222; text-align: left; padding: 8px; color: #aaa; border-bottom: 2px solid #444; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; cursor: default; } /* No sort on top tables */
        .top-table th::after { content: none; }
        .top-table td { padding: 8px; border-bottom: 1px solid #333; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        
        .top-table .col-rank { width: 35px; text-align: right; padding-right: 5px; }
        .top-table .col-name { width: auto; } /* Reszta miejsca dla nazwy */
        .top-table .col-val { width: 90px; text-align: right; }

        .top-table tr:nth-child(1) td { color: #FFD700; font-weight: bold; }
        .top-table tr:nth-child(2) td { color: #C0C0C0; }
        .top-table tr:nth-child(3) td { color: #CD7F32; }

        /* TOAST */
        .toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center;
            border-radius: 4px; padding: 16px; position: fixed; z-index: 10001; left: 50%; bottom: 30px;
            transform: translateX(-50%); box-shadow: 0 0 10px rgba(0,0,0,0.5);
            border-left: 5px solid var(--color-accent); opacity: 0; transition: opacity 0.5s, bottom 0.5s;
        }
        .toast.show { visibility: visible; opacity: 1; bottom: 30px; }
        .toast.success { border-left-color: var(--color-success); }
        .toast.error { border-left-color: var(--color-danger); }

        /* PRINT STYLES */
        @media print {
            @page { size: A4; margin: 1cm; }
            body { background: white; color: black; font-family: 'Helvetica', 'Arial', sans-serif; margin: 0; padding: 0; overflow: visible; display: block; }
            .topbar, .panel, .modal, .tabs, button, .main-content { display: none !important; }
            #printContainer { display: block !important; position: absolute; top: 0; left: 0; width: 100%; color: #000; background: #fff; z-index: 9999; }
            .doc-header { border-bottom: 3px solid #333; padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: flex-end; }
            .doc-title { font-size: 24pt; font-weight: bold; text-transform: uppercase; color: #000; }
            .doc-meta { text-align: right; font-size: 10pt; line-height: 1.4; }
            table.print-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 10pt; }
            table.print-table th { background-color: #f0f0f0; color: black; font-weight: bold; text-align: left; border-bottom: 2px solid #000; padding: 8px; }
            table.print-table td { border-bottom: 1px solid #ddd; padding: 8px; color: black; }
            .print-footer { margin-top: 40px; display: flex; justify-content: space-between; page-break-inside: avoid; }
            .sign-box { width: 40%; border-top: 1px solid #000; padding-top: 5px; text-align: center; font-size: 10pt; }
            .summary-box { text-align: right; margin-top: 20px; font-size: 12pt; border-top: 2px solid #000; padding-top: 5px; }
        }
        #printContainer { display: none; }
    </style>
</head>
<body>
    <!-- TOPBAR -->
    <div class="topbar">
        <h1>Magazyn Gier v3.12 üé≤</h1>
        <button class="btn-primary" onclick="app.modals.openBatchReceipt()">+ Przyjƒôcie (Faktura)</button>
        <button class="btn-warning" onclick="app.modals.openSale()">- Sprzeda≈º</button>
        <button class="btn-secondary" onclick="app.io.exportData()">üíæ Zapisz Backup</button>
        <button class="btn-secondary" onclick="document.getElementById('importFile').click()">üìÇ Wczytaj Backup</button>
        <button class="btn-danger" onclick="app.logic.clearData()">‚ö†Ô∏è RESET DANYCH</button>
        <input type="file" id="importFile" style="display:none" onchange="app.io.importData(this)">
    </div>
<div id="allegro-panel" style="margin: 20px; padding: 15px; background: var(--color-surface); border-radius: 8px; border: 1px solid var(--color-accent);">
    <h3 style="margin-top: 0; color: var(--color-accent);">Automatyzacja Allegro</h3>
    <p id="allegro-status" style="font-size: 0.9em; color: var(--color-text-muted);">Status: Niepo≈ÇƒÖczono</p>
    <button id="btn-allegro-login" onclick="loginToAllegro()" class="btn-primary">Po≈ÇƒÖcz z Allegro</button>
    <button id="btn-allegro-sync" onclick="syncAllegroOrders()" class="btn-secondary" style="display: none;">Pobierz nowe zam√≥wienia</button>
</div>
    <!-- MAIN CONTENT -->
    <div class="main-content">
        <div class="panel">
            <div class="tabs">
                <button class="tab-button active" onclick="app.ui.switchTab('inventory')">üì¶ Stan Magazynowy</button>
                <button class="tab-button" onclick="app.ui.switchTab('collection')">üèÜ Kolekcja</button>
                <button class="tab-button" onclick="app.ui.switchTab('history')">üìú Historia / PZ</button>
                <button class="tab-button" onclick="app.ui.switchTab('inventory-check')">üìù Inwentaryzacja</button>
                <button class="tab-button" onclick="app.ui.switchTab('stats')">üìä Statystyki</button>
                <button class="tab-button" onclick="app.ui.switchTab('settings')">‚öôÔ∏è Ustawienia</button>
            </div>

            <!-- TAB: INVENTORY -->
            <div id="tab-inventory" class="tab-content active">
                <div class="form-grid">
                    <input type="text" id="invSearch" placeholder="Szukaj gry..." oninput="app.ui.filterTable('inventoryTable', this.value)">
                    <select id="invWarehouse" onchange="app.ui.renderInventory()"><option value="">Wszystkie magazyny</option></select>
                    <button class="btn-secondary" onclick="app.print.printInventoryReport()">üñ®Ô∏è Drukuj Raport Warto≈õciowy</button>
                </div>
                <div class="table-container">
                    <table id="inventoryTable">
                        <thead>
                            <tr>
                                <th onclick="app.ui.sortTable('inventoryTable', 0, 'num')">ID</th>
                                <th onclick="app.ui.sortTable('inventoryTable', 1, 'str')">Tytu≈Ç</th>
                                <th onclick="app.ui.sortTable('inventoryTable', 2, 'str')">Wydawca</th>
                                <th onclick="app.ui.sortTable('inventoryTable', 3, 'str')">Magazyn</th>
                                <th onclick="app.ui.sortTable('inventoryTable', 4, 'num')">Ilo≈õƒá</th>
                                <th class="numeric" onclick="app.ui.sortTable('inventoryTable', 5, 'num')">Cena Netto (≈õr)</th>
                                <th class="numeric" onclick="app.ui.sortTable('inventoryTable', 6, 'num')">Warto≈õƒá Netto</th>
                                <th>Akcje</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- TAB: COLLECTION -->
            <div id="tab-collection" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Kolekcja Prywatna / Wypo≈ºyczalnia</h2>
                    <input type="text" id="collSearch" placeholder="Szukaj w kolekcji..." style="max-width: 300px;" oninput="app.ui.filterTable('collectionTable', this.value)">
                </div>
                <div class="table-container">
                    <table id="collectionTable">
                        <thead>
                            <tr>
                                <th onclick="app.ui.sortTable('collectionTable', 0, 'str')">Tytu≈Ç</th>
                                <th onclick="app.ui.sortTable('collectionTable', 1, 'str')">Wydawca</th>
                                <th onclick="app.ui.sortTable('collectionTable', 2, 'num')">Ilo≈õƒá</th>
                                <th class="numeric" onclick="app.ui.sortTable('collectionTable', 3, 'num')">Warto≈õƒá Zakupu</th>
                                <th>Akcje</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- TAB: HISTORY -->
            <div id="tab-history" class="tab-content">
                <div class="form-grid">
                    <input type="text" id="histSearch" placeholder="Szukaj..." oninput="app.ui.filterTable('historyTable', this.value)">
                    <div>
                        <button class="btn-secondary" onclick="app.ui.filterHistory('ADJUSTMENT')">Tylko Inwentaryzacje</button>
                        <button class="btn-secondary" onclick="app.ui.filterHistory('')">Poka≈º Wszystko</button>
                    </div>
                </div>
                <div class="table-container">
                    <table id="historyTable">
                        <thead>
                            <tr>
                                <th onclick="app.ui.sortTable('historyTable', 0, 'str')">ID</th>
                                <th onclick="app.ui.sortTable('historyTable', 1, 'str')">Typ</th>
                                <th onclick="app.ui.sortTable('historyTable', 2, 'str')">Data</th>
                                <th onclick="app.ui.sortTable('historyTable', 3, 'str')">Dokument</th>
                                <th onclick="app.ui.sortTable('historyTable', 4, 'str')">Tre≈õƒá</th>
                                <th onclick="app.ui.sortTable('historyTable', 5, 'num')">Warto≈õƒá</th>
                                <th>Akcja</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- TAB: INVENTORY CHECK -->
            <div id="tab-inventory-check" class="tab-content">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Modu≈Ç Inwentaryzacji</h2>
                    <div>
                        <button class="btn-secondary" onclick="app.ui.goToInventoryArchive()">üìú Poka≈º Archiwum</button>
                        <button class="btn-secondary" onclick="app.print.printInventorySheet()">üñ®Ô∏è Drukuj Arkusz Spisowy</button>
                        <button class="btn-success" onclick="app.logic.commitInventoryCorrection()">‚úÖ Zatwierd≈∫ R√≥≈ºnice</button>
                    </div>
                </div>
                <div class="form-grid" style="margin-bottom: 10px; grid-template-columns: 3fr 1fr;">
                    <input type="text" id="checkSearch" placeholder="Szukaj w spisie..." oninput="app.ui.filterTable('inventoryCheckTable', this.value)">
                    <select id="checkWarehouse" onchange="app.ui.renderInventoryCheck()"><option value="">Wszystkie magazyny / Kolekcja</option></select>
                </div>
                <p>Wpisz faktyczne stany magazynowe. System wygeneruje dokument korekty.</p>
                <div class="table-container">
                    <table id="inventoryCheckTable">
                        <thead>
                            <tr>
                                <th onclick="app.ui.sortTable('inventoryCheckTable', 0, 'str')">Gra</th>
                                <th onclick="app.ui.sortTable('inventoryCheckTable', 1, 'str')">Magazyn</th>
                                <th class="numeric" onclick="app.ui.sortTable('inventoryCheckTable', 2, 'num')">Stan System</th>
                                <th style="width: 150px;">Stan Faktyczny</th>
                                <th class="numeric" onclick="app.ui.sortTable('inventoryCheckTable', 4, 'num')">R√≥≈ºnica</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <!-- TAB: STATS -->
            <div id="tab-stats" class="tab-content">
                <div id="statsContent"></div>
            </div>

            <!-- TAB: SETTINGS -->
            <div id="tab-settings" class="tab-content">
                <h3>S≈Çowniki i Ustawienia</h3>
                <div class="form-grid">
                    <div>
                        <h4>Magazyny</h4>
                        <button class="btn-primary" onclick="app.modals.openManager('warehouse')">+ Dodaj Magazyn</button>
                        <ul id="listWarehouses" class="settings-list"></ul>
                    </div>
                    <div>
                        <h4>Sprzedawcy (Dostawcy)</h4>
                        <button class="btn-primary" onclick="app.modals.openManager('client')">+ Dodaj Sprzedawcƒô</button>
                        <ul id="listClients" class="settings-list"></ul>
                    </div>
                    <div>
                        <h4>Wydawcy</h4>
                        <div style="display:flex; gap:5px; margin-bottom:5px;">
                            <button class="btn-primary" onclick="app.modals.openManager('publisher')">+ Dodaj Wydawcƒô</button>
                            <button class="btn-secondary btn-sm" onclick="document.getElementById('importPublishersJson').click()">üìÇ Import JSON</button>
                            <input type="file" id="importPublishersJson" style="display:none" accept=".json" onchange="app.io.importPublishers(this)">
                        </div>
                        <ul id="listPublishers" class="settings-list"></ul>
                    </div>
                    <div>
                        <h4>Tytu≈Çy Gier</h4>
                        <div style="display:flex; gap:5px; margin-bottom:5px;">
                            <button class="btn-primary" onclick="app.modals.openManager('game')">+ Dodaj Tytu≈Ç</button>
                            <button class="btn-secondary btn-sm" onclick="document.getElementById('importGamesJson').click()">üìÇ Import JSON</button>
                            <input type="file" id="importGamesJson" style="display:none" accept=".json" onchange="app.io.importGames(this)">
                        </div>
                        <ul id="listGames" class="settings-list"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TOAST NOTIFICATION CONTAINER -->
    <div id="toast" class="toast"></div>

    <!-- MODALS -->
    <!-- BATCH RECEIPT (PZ) -->
    <dialog id="modalBatchReceipt" class="modal">
        <div class="modal-content" style="max-width: 1000px;">
            <h2 id="batchReceiptTitle" style="color: var(--color-accent);">Nowe Przyjƒôcie Towaru (PZ)</h2>
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <button class="btn-secondary" onclick="document.getElementById('importInvoiceJson').click()">üìÇ Wczytaj z JSON</button>
                <input type="file" id="importInvoiceJson" style="display:none" accept=".json" onchange="app.io.importInvoice(this)">
            </div>
            <form id="formBatchHeader" class="form-grid" style="background: #333; padding: 10px; border-radius: 4px;">
                <input type="hidden" id="batchEditId" value="">
                <div class="form-group"><label>Numer Faktury</label><input type="text" id="batchInvoiceNo" required placeholder="np. FV/2024/01/99"></div>
                <div class="form-group"><label>Data Dokumentu</label><input type="date" id="batchDate" required></div>
                <div class="form-group"><label>Sprzedawca</label><div class="input-group"><select id="batchClient" required></select><button type="button" class="btn-add-inline" onclick="app.modals.quickAdd('client')">+</button></div></div>
            </form>
            <h4 class="section-header">Pozycje Faktury</h4>
            <div class="form-grid" style="grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto; align-items: end;">
                <div class="form-group"><label>Tytu≈Ç Gry</label><div class="input-group"><select id="batchItemGame"></select><button type="button" class="btn-add-inline" onclick="app.modals.quickAdd('game')">+</button></div></div>
                <div class="form-group"><label>Magazyn</label><select id="batchItemWarehouse"></select></div>
                <div class="form-group"><label>Ilo≈õƒá</label><input type="number" id="batchItemQty" value="1" min="1"></div>
                <div class="form-group"><label>Cena Brutto</label><input type="number" id="batchItemPriceGross" value="0.00" step="0.01"></div>
                <div class="form-group"><label>VAT %</label><select id="batchItemVat"><option value="23" selected>23%</option><option value="8">8%</option><option value="5">5%</option><option value="0">0%</option></select></div>
                <div class="form-group"><button type="button" class="btn-primary" onclick="app.logic.addBatchItem()">Dodaj</button></div>
            </div>
            <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                <table id="batchItemsTable">
                    <thead><tr><th onclick="app.ui.sortTable('batchItemsTable', 0, 'str')">Gra</th><th onclick="app.ui.sortTable('batchItemsTable', 1, 'str')">Mag</th><th onclick="app.ui.sortTable('batchItemsTable', 2, 'num')">Ilo≈õƒá</th><th onclick="app.ui.sortTable('batchItemsTable', 3, 'num')">Cena Netto</th><th>VAT</th><th onclick="app.ui.sortTable('batchItemsTable', 5, 'num')">Cena Brutto</th><th onclick="app.ui.sortTable('batchItemsTable', 6, 'num')">Warto≈õƒá Netto</th><th>Akcja</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="batch-summary">
                <div>Pozycji: <span id="batchCount">0</span></div>
                <div>Suma Netto: <span id="batchTotalNet">0.00 PLN</span></div>
                <div>Suma Brutto: <span id="batchTotalGross">0.00 PLN</span></div>
            </div>
            <div class="actions">
                <button type="button" class="btn-secondary" onclick="document.getElementById('modalBatchReceipt').close()">Anuluj</button>
                <button type="button" class="btn-success" onclick="app.logic.saveBatchReceipt()">Zapisz i Przelicz</button>
            </div>
        </div>
    </dialog>

    <!-- SALE MULTI-ITEM -->
    <dialog id="modalSale" class="modal">
        <div class="modal-content" style="max-width: 850px;">
            <h2 id="saleModalTitle">Rejestracja Sprzeda≈ºy</h2>
            
            <div class="form-grid" style="grid-template-columns: 2fr 1fr 1fr auto; align-items: end; background: #333; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
                <div class="form-group" style="grid-column: span 4;">
                    <label>Wyszukaj Grƒô</label>
                    <input type="text" id="saleSearchInput" placeholder="Wpisz fragment tytu≈Çu..." oninput="app.ui.filterSaleSelect()">
                    <select id="saleGame" size="4" style="margin-top: 5px; width: 100%; max-height: 120px;" onchange="app.ui.updateSaleMaxQty()"></select>
                </div>
                <div class="form-group">
                    <label>Ilo≈õƒá (Dostƒôpne: <span id="saleMaxQty" style="color:var(--color-accent)">0</span>)</label>
                    <input type="number" id="saleQty" min="1" value="1">
                </div>
                <div class="form-group">
                    <label>Cena Brutto / szt.</label>
                    <input type="number" id="salePrice" step="0.01" placeholder="0.00">
                </div>
                <div class="form-group" style="display: flex; gap: 5px;">
                    <button type="button" class="btn-success" onclick="app.logic.addSaleItem()" style="height: 40px; margin-bottom: 5px;">+ Dodaj do rachunku</button>
                </div>
            </div>

            <div class="table-container" style="max-height: 250px;">
                <table id="saleItemsTable">
                    <thead>
                        <tr>
                            <th>Gra</th>
                            <th>Magazyn</th>
                            <th class="numeric">Ilo≈õƒá</th>
                            <th class="numeric">Cena Brutto</th>
                            <th class="numeric">Warto≈õƒá Brutto</th>
                            <th>Akcja</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>

            <div class="batch-summary">
                <div></div>
                <div>Suma Brutto: <span id="saleTotalGross">0.00 PLN</span></div>
            </div>

            <form id="formSale" onsubmit="event.preventDefault(); app.logic.processSale();" style="margin-top: 15px;">
                <input type="hidden" id="saleEditId" value="">
                <div class="form-grid">
                    <div class="form-group"><label>Data Sprzeda≈ºy</label><input type="date" id="saleDate" required></div>
                    <div class="form-group"><label>Klient / Zam√≥wienie (Opcjonalnie)</label><input type="text" id="saleClient" placeholder="np. Allegro #1234, Jan Kowalski"></div>
                </div>
                <div class="actions">
                    <button type="button" class="btn-secondary" onclick="document.getElementById('modalSale').close()">Anuluj</button>
                    <button type="submit" class="btn-warning">Zatwierd≈∫ Sprzeda≈º</button>
                </div>
            </form>
        </div>
    </dialog>
    
    <!-- TRANSFER (MM) -->
    <dialog id="modalTransfer" class="modal">
        <div class="modal-content">
            <h2 id="transferTitle">Przesuniƒôcie Miƒôdzymagazynowe (MM)</h2>
            <form id="formTransfer" onsubmit="event.preventDefault(); app.logic.processTransfer();">
                <input type="hidden" id="transferEditId">
                <input type="hidden" id="transferGameId">
                <p>Towar: <strong id="transferGameTitle"></strong></p>
                <div class="form-grid">
                    <div class="form-group"><label>Z Magazynu</label><input type="text" id="transferFromWh" disabled></div>
                    <div class="form-group"><label>Do Magazynu</label><select id="transferToWh" required></select></div>
                    <div class="form-group"><label>Ilo≈õƒá (Max: <span id="transferMaxQty"></span>)</label><input type="number" id="transferQty" min="1" required></div>
                </div>
                <div class="actions">
                    <button type="button" class="btn-secondary" onclick="document.getElementById('modalTransfer').close()">Anuluj</button>
                    <button type="submit" class="btn-primary">Zapisz</button>
                </div>
            </form>
        </div>
    </dialog>

    <!-- ADJUSTMENT (INWENT) - SINGLE EDIT -->
    <dialog id="modalAdjustment" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h2>Edycja Korekty (Inwentaryzacja)</h2>
            <form id="formAdjustment" onsubmit="event.preventDefault(); app.logic.saveAdjustment();">
                <input type="hidden" id="adjEditId">
                <p>Gra: <strong id="adjGameTitle"></strong> | Magazyn: <strong id="adjWarehouse"></strong></p>
                <div class="form-grid">
                    <div class="form-group"><label>R√≥≈ºnica Ilo≈õci (np. -1, 5)</label><input type="number" id="adjQtyDiff" required></div>
                </div>
                <div class="actions">
                    <button type="button" class="btn-secondary" onclick="document.getElementById('modalAdjustment').close()">Anuluj</button>
                    <button type="submit" class="btn-primary">Zapisz Zmianƒô</button>
                </div>
            </form>
        </div>
    </dialog>
    
    <!-- MANAGER -->
    <dialog id="modalManager" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <h2 id="managerTitle">Dodaj/Edytuj</h2>
            <form id="formManager" onsubmit="event.preventDefault(); app.logic.saveManagerItem();">
                <input type="hidden" id="managerType"><input type="hidden" id="managerId">
                <div class="form-grid">
                    <!-- New Smart Match Feature -->
                    <div class="form-group" id="managerExistingGroup">
                        <label>Po≈ÇƒÖcz z istniejƒÖcym (Opcjonalnie)</label>
                        <select id="managerExistingSelect" onchange="app.ui.toggleManagerInput()"></select>
                    </div>

                    <div class="form-group"><label>Nazwa (Nowa / Edytowana)</label><input type="text" id="managerName" required></div>
                    <div class="form-group" id="managerPublisherCodeGroup" style="display:none;"><label>Kod</label><input type="text" id="managerPublisherCode"></div>
                    <div class="form-group" id="managerGamePublisherGroup" style="display:none;"><label>Wydawca</label><div class="input-group"><select id="managerGamePublisher"></select><button type="button" class="btn-add-inline" onclick="app.modals.quickAdd('publisher')">+</button></div></div>
                </div>
                <div class="actions">
                    <button type="button" class="btn-secondary" onclick="document.getElementById('modalManager').close()">Anuluj</button>
                    <button type="submit" class="btn-primary">Zapisz</button>
                </div>
            </form>
        </div>
    </dialog>
    
    <!-- ITEM HISTORY -->
    <dialog id="modalItemHistory" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <h2 style="color: var(--color-accent);">Kartoteka Produktu: <span id="itemHistoryTitle"></span></h2>
            
            <div style="display:flex; flex-wrap:wrap; gap:15px; margin-bottom:15px;">
                <!-- Publisher Edit Section -->
                <div style="flex-grow:1; padding: 10px; background: #333; border-radius: 4px; display: flex; align-items: center; gap: 10px;">
                    <input type="hidden" id="itemHistoryGameId">
                    <span>Wydawca:</span>
                    <select id="itemHistoryPublisher" style="width: auto; margin: 0; flex-grow: 1;"></select>
                    <button class="btn-success btn-sm" onclick="app.logic.updateGamePublisher()">Zapisz</button>
                </div>
                
                <!-- Price Correction Section -->
                <div style="flex-grow:1; padding: 10px; background: #333; border-radius: 4px; display: flex; align-items: center; gap: 10px;">
                    <span>Korekta Warto≈õci / Ceny (Netto):</span>
                    <input type="number" id="itemHistoryNewPrice" step="0.01" placeholder="Nowa cena ≈õr." style="width: 120px; margin:0;">
                    <button class="btn-warning btn-sm" onclick="app.logic.addRevaluation()">Przeszacuj</button>
                </div>
            </div>

            <div class="table-container">
                <table id="itemHistoryTable"><thead><tr><th onclick="app.ui.sortTable('itemHistoryTable', 0, 'str')">Data</th><th onclick="app.ui.sortTable('itemHistoryTable', 1, 'str')">Dokument</th><th onclick="app.ui.sortTable('itemHistoryTable', 2, 'str')">Typ</th><th onclick="app.ui.sortTable('itemHistoryTable', 3, 'num')">Przych√≥d</th><th onclick="app.ui.sortTable('itemHistoryTable', 4, 'num')">Rozch√≥d</th><th onclick="app.ui.sortTable('itemHistoryTable', 5, 'num')">Cena</th><th onclick="app.ui.sortTable('itemHistoryTable', 6, 'str')">Magazyn</th></tr></thead><tbody></tbody></table>
            </div>
            <div class="actions"><button type="button" class="btn-secondary" onclick="document.getElementById('modalItemHistory').close()">Zamknij</button></div>
        </div>
    </dialog>

    <div id="printContainer"></div>

    <script>
        const STORAGE_KEY = 'boardgame_erp_v3_7';
        const DEFAULT_WH = 'G≈Ç√≥wny';
        const COLL_WH = 'Kolekcja';

        const app = {
            data: {
                clients: [], publishers: [], games: [], warehouses: [DEFAULT_WH, 'Sklep', COLL_WH],
                history: [], inventory: []
            },
            tempBatchItems: [],
            tempSaleItems: [],
            historyFilter: '',
            wizard: { active: false, queue: [], invoiceData: null },

            init: () => {
                try {
                    app.io.load();
                    app.ui.initDates();
                    app.logic.recalculateInventory();
                    app.ui.renderInventory();
                    app.ui.setupSettings();
                } catch (err) {
                    if(confirm("B≈ÇƒÖd danych. Zresetowaƒá?")) { localStorage.removeItem(STORAGE_KEY); location.reload(); }
                }
            },

            logic: {
                clearData: () => { if(confirm("UsunƒÖƒá WSZYSTKO?")) { localStorage.removeItem(STORAGE_KEY); location.reload(); } },

                recalculateInventory: () => {
                    const invMap = {}; 
                    const sortedHistory = [...(app.data.history || [])].sort((a,b) => new Date(a.date) - new Date(b.date));
                    sortedHistory.forEach(entry => {
                        if (entry.type === 'RECEIPT') {
                            entry.items.forEach(item => {
                                const key = `${item.gameId}|${item.warehouse}`;
                                if (!invMap[key]) invMap[key] = { gameId: item.gameId, warehouse: item.warehouse, qty: 0, val: 0, valGross: 0, lastNetPrice: 0 };
                                invMap[key].qty += item.qty; 
                                invMap[key].val += (item.priceNet * item.qty);
                                invMap[key].valGross += (item.priceGross * item.qty);
                                invMap[key].lastNetPrice = item.priceNet; // Update last price
                            });
                        } else if (entry.type === 'SALE') {
                            // Wsparcie dla nowych wielopozycyjnych paragon√≥w i starych pojedynczych
                            const itemsToProcess = entry.items ? entry.items : [entry];
                            
                            itemsToProcess.forEach(sItem => {
                                const key = `${sItem.gameId}|${sItem.warehouse}`;
                                if (invMap[key]) {
                                    const avgCost = invMap[key].qty > 0 ? invMap[key].val / invMap[key].qty : 0;
                                    const avgGross = invMap[key].qty > 0 ? invMap[key].valGross / invMap[key].qty : 0;
                                    invMap[key].qty -= sItem.qty; 
                                    invMap[key].val -= (avgCost * sItem.qty);
                                    invMap[key].valGross -= (avgGross * sItem.qty);
                                }
                            });
                        } else if (entry.type === 'ADJUSTMENT') {
                            const key = `${entry.gameId}|${entry.warehouse}`;
                             if (!invMap[key]) invMap[key] = { gameId: entry.gameId, warehouse: entry.warehouse, qty: 0, val: 0, valGross: 0, lastNetPrice: 0 };
                             const unitVal = entry.unitVal !== undefined ? entry.unitVal : (invMap[key].qty > 0 ? invMap[key].val / invMap[key].qty : 0);
                             const avgGross = invMap[key].qty > 0 ? invMap[key].valGross / invMap[key].qty : unitVal * 1.23;
                             invMap[key].qty += entry.qtyDiff; 
                             invMap[key].val += (unitVal * entry.qtyDiff);
                             invMap[key].valGross += (avgGross * entry.qtyDiff);
                        } else if (entry.type === 'TRANSFER') {
                            const keyFrom = `${entry.gameId}|${entry.fromWh}`; const keyTo = `${entry.gameId}|${entry.toWh}`;
                            if(!invMap[keyTo]) invMap[keyTo] = { gameId: entry.gameId, warehouse: entry.toWh, qty: 0, val: 0, valGross: 0, lastNetPrice: 0 };
                            const avgCost = (invMap[keyFrom] && invMap[keyFrom].qty > 0) ? invMap[keyFrom].val / invMap[keyFrom].qty : 0;
                            const avgGross = (invMap[keyFrom] && invMap[keyFrom].qty > 0) ? invMap[keyFrom].valGross / invMap[keyFrom].qty : 0;
                            
                            // Carry over last price if transferring to new slot
                            if(invMap[keyFrom]) invMap[keyTo].lastNetPrice = invMap[keyFrom].lastNetPrice;

                            if(invMap[keyFrom]) { 
                                invMap[keyFrom].qty -= entry.qty; 
                                invMap[keyFrom].val -= (avgCost * entry.qty); 
                                invMap[keyFrom].valGross -= (avgGross * entry.qty);
                            }
                            invMap[keyTo].qty += entry.qty; 
                            invMap[keyTo].val += (avgCost * entry.qty);
                            invMap[keyTo].valGross += (avgGross * entry.qty);
                        } else if (entry.type === 'REVALUATION') {
                            const key = `${entry.gameId}|${entry.warehouse}`;
                            if (invMap[key]) {
                                invMap[key].val += entry.valDiff;
                            }
                        }
                    });
                    
                    app.data.inventory = Object.values(invMap).map(i => {
                        if (Math.abs(i.qty) < 0.001) i.qty = 0;
                        return i;
                    });
                },

                deleteHistoryEntry: (id) => {
                    if(!confirm("UsunƒÖƒá wpis?")) return;
                    app.data.history = app.data.history.filter(h => h.id !== id);
                    app.io.save(); app.logic.recalculateInventory(); app.ui.renderInventory(); app.ui.renderHistory();
                },

                deleteManagerItem: (type, idOrName) => {
                    if(!confirm("UsunƒÖƒá?")) return;
                    if(type === 'game') app.data.games = app.data.games.filter(x => x.id !== idOrName);
                    if(type === 'publisher') app.data.publishers = app.data.publishers.filter(x => x.id !== idOrName);
                    if(type === 'client') app.data.clients = app.data.clients.filter(x => x.id !== idOrName);
                    if(type === 'warehouse') app.data.warehouses = app.data.warehouses.filter(x => x !== idOrName);
                    app.io.save(); app.ui.setupSettings();
                },
                
                deleteGameFull: (id) => {
                    if(!confirm("UWAGA! To usunie definicjƒô gry ORAZ ca≈ÇƒÖ jej historiƒô operacji (PZ, WZ, Korekty). Czy na pewno chcesz usunƒÖƒá tƒô pozycjƒô ca≈Çkowicie?")) return;
                    app.data.history = app.data.history.filter(h => {
                        if (h.gameId === id) return false;
                        if (h.type === 'SALE' && h.items) {
                            h.items = h.items.filter(i => i.gameId !== id);
                            if(h.items.length === 0) return false;
                            h.totalVal = h.items.reduce((s,i) => s + i.totalVal, 0);
                        }
                        if (h.type === 'RECEIPT' && h.items) {
                            h.items = h.items.filter(i => i.gameId !== id);
                            if(h.items.length === 0) return false;
                            h.totalNet = h.items.reduce((s,i)=>s+i.totalNet, 0);
                            h.totalGross = h.items.reduce((s,i)=>s+i.totalGross, 0);
                        }
                        return true;
                    });
                    app.data.games = app.data.games.filter(g => g.id !== id);
                    app.io.save();
                    app.logic.recalculateInventory();
                    app.ui.renderInventory();
                    app.ui.setupSettings();
                    app.ui.showToast('Usuniƒôto grƒô i jej historiƒô.', 'error');
                },

                addRevaluation: () => {
                    const gameId = parseInt(document.getElementById('itemHistoryGameId').value);
                    const newPrice = parseFloat(document.getElementById('itemHistoryNewPrice').value);
                    if (!gameId || isNaN(newPrice)) return alert("Podaj poprawnƒÖ cenƒô.");
                    const invItems = app.data.inventory.filter(i => i.gameId === gameId && i.qty > 0);
                    if (invItems.length === 0) return alert("Brak stanu magazynowego do przeszacowania.");
                    invItems.forEach(inv => {
                        const currentVal = inv.val;
                        const targetVal = inv.qty * newPrice;
                        const diff = targetVal - currentVal;
                        if (Math.abs(diff) > 0.01) {
                            app.data.history.push({
                                id: Date.now() + Math.random(), type: 'REVALUATION', date: new Date().toISOString().split('T')[0],
                                gameId: gameId, warehouse: inv.warehouse, valDiff: diff, invoiceNo: 'PRZESZACOWANIE', qtyDiff: 0
                            });
                        }
                    });
                    app.io.save(); app.logic.recalculateInventory(); app.ui.renderInventory();
                    app.ui.showToast('Warto≈õƒá magazynu zaktualizowana.');
                    document.getElementById('itemHistoryNewPrice').value = '';
                    app.modals.openItemHistory(gameId);
                },
                
                processNextWizardStep: () => {
                    if (app.wizard.queue.length === 0) {
                        app.wizard.active = false;
                        document.getElementById('modalBatchReceipt').showModal(); 
                        app.ui.populateBatchFromInvoice(app.wizard.invoiceData);
                        return;
                    }
                    const item = app.wizard.queue[0];
                    app.modals.openManager(item.type, null, item.name);
                },

                // --- BATCH RECEIPT ---
                addBatchItem: () => {
                    const gameId = document.getElementById('batchItemGame').value;
                    const wh = document.getElementById('batchItemWarehouse').value;
                    const qty = parseInt(document.getElementById('batchItemQty').value);
                    const gross = parseFloat(document.getElementById('batchItemPriceGross').value);
                    const vat = parseInt(document.getElementById('batchItemVat').value);
                    const game = app.data.games.find(g => g.id == gameId);
                    if (!game || qty<=0) return alert("B≈ÇƒÖd danych.");
                    const net = gross / (1 + vat/100);
                    app.data.tempBatchItems.push({
                        gameId: parseInt(gameId), gameTitle: game.title, warehouse: wh, qty: qty, priceGross: gross, vat: vat, priceNet: net, totalNet: net * qty, totalGross: gross * qty
                    });
                    app.ui.renderBatchItems();
                },
                removeBatchItem: (i) => { app.data.tempBatchItems.splice(i, 1); app.ui.renderBatchItems(); },
                saveBatchReceipt: () => {
                    const invoiceNo = document.getElementById('batchInvoiceNo').value;
                    const clientId = document.getElementById('batchClient').value;
                    const date = document.getElementById('batchDate').value;
                    const editId = document.getElementById('batchEditId').value;
                    if (!invoiceNo || !clientId || app.data.tempBatchItems.length === 0) return alert('Brak danych.');
                    const entry = {
                        id: editId ? parseInt(editId) : Date.now(), type: 'RECEIPT', date, invoiceNo, clientId,
                        items: [...app.data.tempBatchItems],
                        totalNet: app.data.tempBatchItems.reduce((s, i) => s + i.totalNet, 0),
                        totalGross: app.data.tempBatchItems.reduce((s, i) => s + i.totalGross, 0)
                    };
                    if (editId) { const idx = app.data.history.findIndex(h => h.id == editId); if(idx > -1) app.data.history[idx] = entry; }
                    else app.data.history.push(entry);
                    app.io.save(); app.logic.recalculateInventory(); app.ui.renderInventory(); app.ui.renderHistory();
                    document.getElementById('modalBatchReceipt').close();
                },

                // --- SALE (NEW MULTI ITEM) ---
                addSaleItem: () => {
                    const gameSel = document.getElementById('saleGame');
                    if(gameSel.selectedIndex < 0) return alert("Wybierz grƒô z listy po wyszukaniu.");
                    
                    const opt = gameSel.options[gameSel.selectedIndex];
                    const gameId = parseInt(opt.value);
                    const warehouse = opt.dataset.wh;
                    const qty = parseInt(document.getElementById('saleQty').value);
                    const price = parseFloat(document.getElementById('salePrice').value);

                    if(qty <= 0 || isNaN(qty)) return alert("B≈Çƒôdna ilo≈õƒá.");
                    if(isNaN(price)) return alert("Podaj prawid≈ÇowƒÖ cenƒô brutto.");

                    const invItem = app.data.inventory.find(i => i.gameId == gameId && i.warehouse === warehouse);
                    if(!invItem || invItem.qty < qty) return alert("Brak wystarczajƒÖcej ilo≈õci na magazynie!");

                    const game = app.data.games.find(g => g.id == gameId);

                    app.tempSaleItems.push({
                        gameId: gameId,
                        title: game.title,
                        warehouse: warehouse,
                        qty: qty,
                        price: price, // gross
                        totalVal: qty * price // gross
                    });

                    document.getElementById('saleQty').value = 1;
                    document.getElementById('salePrice').value = '';
                    app.ui.renderSaleItems();
                },
                removeSaleItem: (idx) => {
                    app.tempSaleItems.splice(idx, 1);
                    app.ui.renderSaleItems();
                },
                processSale: () => {
                    const editId = document.getElementById('saleEditId').value;
                    const date = document.getElementById('saleDate').value;
                    const client = document.getElementById('saleClient').value;

                    if (app.tempSaleItems.length === 0) return alert('Koszyk jest pusty! Najpierw wyszukaj grƒô i dodaj jƒÖ przyciskiem "+ Dodaj do rachunku".');

                    const totalVal = app.tempSaleItems.reduce((sum, item) => sum + item.totalVal, 0);

                    const entry = {
                        id: editId ? parseInt(editId) : Date.now(),
                        type: 'SALE',
                        date: date,
                        client: client,
                        items: [...app.tempSaleItems],
                        totalVal: totalVal // Total Gross
                    };

                    if (editId) { 
                        const idx = app.data.history.findIndex(h => h.id == editId); 
                        if(idx > -1) app.data.history[idx] = entry; 
                    } else { 
                        app.data.history.push(entry); 
                    }
                    
                    app.io.save(); 
                    app.logic.recalculateInventory(); 
                    app.ui.renderInventory(); 
                    app.ui.renderHistory();
                    document.getElementById('modalSale').close();
                },
                
                processTransfer: () => {
                    const editId = document.getElementById('transferEditId').value;
                    const gameId = parseInt(document.getElementById('transferGameId').value);
                    const fromWh = document.getElementById('transferFromWh').value;
                    const toWh = document.getElementById('transferToWh').value;
                    const qty = parseInt(document.getElementById('transferQty').value);
                    if(fromWh === toWh || qty <= 0) return alert("B≈ÇƒÖd danych.");
                    
                    const entry = {
                        id: editId ? parseInt(editId) : Date.now(), type: 'TRANSFER', date: new Date().toISOString().split('T')[0],
                        gameId, fromWh, toWh, qty, invoiceNo: 'MM'
                    };
                    
                    if(editId) {
                        const idx = app.data.history.findIndex(h => h.id == editId);
                        if(idx > -1) app.data.history[idx] = entry;
                    } else {
                        app.data.history.push(entry);
                    }
                    
                    app.io.save(); app.logic.recalculateInventory(); app.ui.renderInventory(); app.ui.renderHistory();
                    document.getElementById('modalTransfer').close();
                },

                saveAdjustment: () => {
                    const id = document.getElementById('adjEditId').value;
                    const qtyDiff = parseFloat(document.getElementById('adjQtyDiff').value);
                    
                    const idx = app.data.history.findIndex(h => h.id == id);
                    if(idx > -1) {
                        app.data.history[idx].qtyDiff = qtyDiff;
                        app.io.save(); app.logic.recalculateInventory(); app.ui.renderInventory(); app.ui.renderHistory();
                        document.getElementById('modalAdjustment').close();
                    }
                },

                saveManagerItem: () => {
                    const type = document.getElementById('managerType').value;
                    const id = document.getElementById('managerId').value;
                    const name = document.getElementById('managerName').value;
                    
                    const existingSelect = document.getElementById('managerExistingSelect');
                    const existingId = existingSelect ? existingSelect.value : '';
                    let savedItem = null;

                    if (existingId && existingId !== 'NEW') {
                        if (type === 'client') savedItem = app.data.clients.find(c => c.id == existingId);
                        else if (type === 'game') savedItem = app.data.games.find(g => g.id == existingId);
                        else if (type === 'publisher') savedItem = app.data.publishers.find(p => p.id == existingId);
                    } else {
                        if(type === 'warehouse') { if(!app.data.warehouses.includes(name)) app.data.warehouses.push(name); } 
                        else {
                            const newItem = { id: id ? parseInt(id) : Date.now(), name: name };
                            if(type === 'client') {
                                if(id) { const idx = app.data.clients.findIndex(c => c.id == id); app.data.clients[idx] = newItem; }
                                else { app.data.clients.push(newItem); savedItem = newItem; }
                            } else if (type === 'publisher') {
                                newItem.code = document.getElementById('managerPublisherCode').value;
                                if(id) { const idx = app.data.publishers.findIndex(p => p.id == id); app.data.publishers[idx] = newItem; }
                                else { app.data.publishers.push(newItem); savedItem = newItem; }
                            } else if (type === 'game') {
                                newItem.title = name; delete newItem.name;
                                newItem.publisherId = document.getElementById('managerGamePublisher').value;
                                if(id) { const idx = app.data.games.findIndex(g => g.id == id); app.data.games[idx] = newItem; }
                                else { app.data.games.push(newItem); savedItem = newItem; }
                            }
                        }
                    }

                    app.io.save(); app.ui.setupSettings(); document.getElementById('modalManager').close(); app.ui.renderInventory();
                    app.modals.populateBatchSelects();

                    if (app.wizard.active && savedItem) {
                        const currentWizardItem = app.wizard.queue[0];
                        if (currentWizardItem.type === type) {
                            if (type === 'game') {
                                app.wizard.invoiceData.items.forEach(i => {
                                    if (i.title === currentWizardItem.name) { i.title = savedItem.title; }
                                });
                            }
                            if (type === 'client') {
                                app.wizard.invoiceData.sellerName = savedItem.name;
                            }
                            app.wizard.queue.shift();
                            app.logic.processNextWizardStep();
                        } else {
                            app.modals.openManager(currentWizardItem.type, null, currentWizardItem.name);
                        }
                    }
                },
                
                updateGamePublisher: () => {
                    const gameId = document.getElementById('itemHistoryGameId').value;
                    const newPublisherId = document.getElementById('itemHistoryPublisher').value;
                    
                    const game = app.data.games.find(g => g.id == gameId);
                    if(game) {
                        game.publisherId = parseInt(newPublisherId);
                        app.io.save();
                        app.ui.showToast('Wydawca zosta≈Ç zaktualizowany.');
                        app.ui.renderInventory();
                        app.ui.renderCollection();
                    } else {
                        alert('B≈ÇƒÖd: Nie znaleziono gry.');
                    }
                },

                commitInventoryCorrection: () => {
                    const inputs = document.querySelectorAll('.inv-check-input');
                    let corrections = [];
                    const valMap = {};
                    app.data.inventory.forEach(i => { valMap[`${i.gameId}|${i.warehouse}`] = i.qty > 0 ? i.val / i.qty : 0; });

                    inputs.forEach(input => {
                        const system = parseFloat(input.dataset.system);
                        const actual = parseFloat(input.value);
                        if (!isNaN(actual) && actual !== system) {
                            corrections.push({
                                type: 'ADJUSTMENT', date: new Date().toISOString().split('T')[0],
                                gameId: parseInt(input.dataset.game), warehouse: input.dataset.wh, qtyDiff: actual - system,
                                unitVal: valMap[`${input.dataset.game}|${input.dataset.wh}`] || 0, invoiceNo: 'KOREKTA'
                            });
                        }
                    });
                    if(corrections.length > 0 && confirm("Zatwierdziƒá r√≥≈ºnice?")) {
                        corrections.forEach(c => c.id = Date.now() + Math.random());
                        app.data.history.push(...corrections);
                        app.io.save(); app.logic.recalculateInventory(); app.ui.renderInventory(); app.ui.renderInventoryCheck();
                    }
                }
            },

            ui: {
                showToast: (message, type = 'success') => {
                    const toast = document.getElementById('toast');
                    toast.className = `toast show ${type}`;
                    toast.innerText = message;
                    setTimeout(() => { toast.className = toast.className.replace('show', ''); }, 3000);
                },
                
                toggleManagerInput: () => {
                    const sel = document.getElementById('managerExistingSelect');
                    const inputName = document.getElementById('managerName');
                    const pubGroup = document.getElementById('managerPublisherCodeGroup');
                    const gameGroup = document.getElementById('managerGamePublisherGroup');
                    
                    if (sel.value && sel.value !== 'NEW') {
                        inputName.disabled = true;
                        if(pubGroup) pubGroup.style.opacity = '0.5';
                        if(gameGroup) gameGroup.style.opacity = '0.5';
                    } else {
                        inputName.disabled = false;
                        if(pubGroup) pubGroup.style.opacity = '1';
                        if(gameGroup) gameGroup.style.opacity = '1';
                    }
                },

                initDates: () => {
                    const today = new Date().toISOString().split('T')[0];
                    const batchDate = document.getElementById('batchDate');
                    const saleDate = document.getElementById('saleDate');
                    if(batchDate) batchDate.value = today;
                    if(saleDate) saleDate.value = today;
                },
                switchTab: (tabId) => {
                    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
                    document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
                    const tab = document.getElementById('tab-' + tabId);
                    if(tab) tab.classList.add('active');
                    if(event && event.target) event.target.classList.add('active'); 
                    
                    if(tabId === 'inventory-check') app.ui.renderInventoryCheck();
                    if(tabId === 'collection') app.ui.renderCollection();
                    if(tabId === 'settings') app.ui.setupSettings();
                    if(tabId === 'stats') app.ui.renderStats();
                },
                goToInventoryArchive: () => { app.ui.switchTab('history'); app.ui.filterHistory('ADJUSTMENT'); },
                filterHistory: (type) => { app.historyFilter = type; app.ui.renderHistory(); },

                filterTable: (tableId, searchText) => {
                    const table = document.getElementById(tableId);
                    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
                    const filter = searchText.toLowerCase();
                    
                    for (let i = 0; i < rows.length; i++) {
                        const cells = rows[i].getElementsByTagName('td');
                        let match = false;
                        for (let j = 0; j < cells.length; j++) {
                            if (cells[j].innerText.toLowerCase().indexOf(filter) > -1) {
                                match = true; break;
                            }
                        }
                        rows[i].style.display = match ? "" : "none";
                    }
                },

                sortTable: (tableId, colIndex, type) => {
                    const table = document.getElementById(tableId);
                    const tbody = table.querySelector('tbody');
                    const rows = Array.from(tbody.rows);
                    const header = table.querySelectorAll('th')[colIndex];
                    let asc = !header.classList.contains('sort-asc');

                    table.querySelectorAll('th').forEach(th => th.classList.remove('sort-asc', 'sort-desc'));
                    header.classList.toggle('sort-asc', asc);
                    header.classList.toggle('sort-desc', !asc);

                    rows.sort((a, b) => {
                        let valA = a.cells[colIndex].innerText.trim();
                        let valB = b.cells[colIndex].innerText.trim();

                        if (type === 'num') {
                            valA = parseFloat(valA.replace(/[^0-9.-]/g, '')) || 0;
                            valB = parseFloat(valB.replace(/[^0-9.-]/g, '')) || 0;
                        } else {
                            valA = valA.toLowerCase();
                            valB = valB.toLowerCase();
                        }

                        if (valA < valB) return asc ? -1 : 1;
                        if (valA > valB) return asc ? 1 : -1;
                        return 0;
                    });

                    rows.forEach(row => tbody.appendChild(row));
                },

                renderInventory: () => {
                    const tbody = document.querySelector('#inventoryTable tbody');
                    const whFilter = document.getElementById('invWarehouse').value;
                    tbody.innerHTML = '';
                    app.data.inventory.filter(i => i.warehouse !== COLL_WH).forEach(item => {
                        if (whFilter && item.warehouse !== whFilter) return;
                        const game = app.data.games.find(g => g.id == item.gameId) || {title: 'N/A', publisherId: 0};
                        const pub = app.data.publishers.find(p => p.id == game.publisherId);
                        
                        let avgPrice = 0;
                        let priceDisplay = '';
                        
                        if(item.qty > 0) {
                            avgPrice = item.val / item.qty;
                            priceDisplay = avgPrice.toFixed(2) + ' z≈Ç';
                        } else {
                            priceDisplay = `<span style="color:#666; font-style:italic">(${item.lastNetPrice ? item.lastNetPrice.toFixed(2) : '0.00'})</span>`;
                        }

                        tbody.innerHTML += `<tr><td>${item.gameId}</td><td>${game.title}</td><td>${pub?pub.name:'-'}</td><td>${item.warehouse}</td><td><strong>${item.qty}</strong></td><td class="numeric">${priceDisplay}</td><td class="numeric">${item.val.toFixed(2)} z≈Ç</td><td><button class="btn-warning btn-sm" onclick="app.modals.openSalePrefill(${item.gameId})">Sprzedaj</button><button class="btn-primary btn-sm" onclick="app.modals.openTransfer(${item.gameId}, '${item.warehouse}')">Przesu≈Ñ</button><button class="btn-secondary btn-sm" onclick="app.modals.openItemHistory(${item.gameId})">Kartoteka</button><button class="btn-delete-icon" style="margin-left:5px" onclick="app.logic.deleteGameFull(${item.gameId})">X</button></td></tr>`;
                    });
                    
                    const whSelect = document.getElementById('invWarehouse');
                    if(whSelect.options.length === 1) (app.data.warehouses || []).filter(w => w !== COLL_WH).forEach(w => whSelect.innerHTML += `<option>${w}</option>`);
                    
                    const searchInput = document.getElementById('invSearch');
                    if(searchInput && searchInput.value) app.ui.filterTable('inventoryTable', searchInput.value);
                },
                renderCollection: () => {
                    const tbody = document.querySelector('#collectionTable tbody'); tbody.innerHTML = '';
                    app.data.inventory.filter(i => i.warehouse === COLL_WH).forEach(item => {
                        const game = app.data.games.find(g => g.id == item.gameId) || {title: 'N/A'};
                        const pub = app.data.publishers.find(p => p.id == game.publisherId);
                        tbody.innerHTML += `<tr><td>${game.title}</td><td>${pub?pub.name:'-'}</td><td><strong>${item.qty}</strong></td><td class="numeric">${item.val.toFixed(2)} z≈Ç</td><td><button class="btn-primary btn-sm" onclick="app.modals.openTransfer(${item.gameId}, '${item.warehouse}')">Przesu≈Ñ</button><button class="btn-secondary btn-sm" onclick="app.modals.openItemHistory(${item.gameId})">Historia</button></td></tr>`;
                    });
                    const searchInput = document.getElementById('collSearch');
                    if(searchInput && searchInput.value) app.ui.filterTable('collectionTable', searchInput.value);
                },
                renderHistory: () => {
                    const tbody = document.querySelector('#historyTable tbody'); tbody.innerHTML = '';
                    [...(app.data.history || [])].reverse().forEach(h => {
                        if (app.historyFilter && h.type !== app.historyFilter) return;
                        let desc = '', val = 0, typeLbl = h.type, actions = '';
                        
                        if (h.type === 'RECEIPT') {
                            const client = app.data.clients.find(c => c.id == h.clientId);
                            const clientName = client ? client.name : '';
                            desc = `PZ: ${clientName} ${h.invoiceNo}`; 
                            val = h.totalNet; typeLbl = '<span style="color:var(--color-success)">PRZYJƒòCIE</span>';
                            actions = `<button class="btn-primary btn-sm" onclick="app.print.printPZ(${h.id})">Drukuj</button><button class="btn-secondary btn-sm" onclick="app.modals.editReceipt(${h.id})">Edytuj</button>`;
                        } else if (h.type === 'SALE') {
                            const itemsCount = h.items ? h.items.reduce((sum, i) => sum + i.qty, 0) : h.qty;
                            const firstGameId = h.items ? h.items[0].gameId : h.gameId;
                            const game = app.data.games.find(g => g.id == firstGameId);
                            let gameTitle = game ? game.title : 'Nieznana gra';
                            if (h.items && h.items.length > 1) gameTitle += ` (+${h.items.length - 1} inne)`;
                            desc = `Sprzeda≈º: ${gameTitle} (${itemsCount} szt)`; 
                            val = h.totalVal; typeLbl = '<span style="color:var(--color-warning)">SPRZEDA≈ª</span>';
                            actions = `<button class="btn-primary btn-sm" onclick="app.print.printSale(${h.id})">Drukuj</button><button class="btn-secondary btn-sm" onclick="app.modals.editSale(${h.id})">Edytuj</button>`;
                        } else if (h.type === 'ADJUSTMENT') {
                            const game = app.data.games.find(g => g.id == h.gameId);
                            const gameTitle = game ? game.title : 'Nieznana gra';
                            desc = `${gameTitle}: ${h.qtyDiff > 0 ? '+' : ''}${h.qtyDiff} szt`; val = h.qtyDiff * (h.unitVal || 0); typeLbl = '<span style="color:var(--color-accent)">INWENT.</span>';
                            actions = `<button class="btn-primary btn-sm" onclick="app.print.printAdjustmentSingle(${h.id})">Drukuj</button><button class="btn-secondary btn-sm" onclick="app.modals.openAdjustment(${h.id})">Edytuj</button>`;
                        } else if (h.type === 'TRANSFER') {
                            const game = app.data.games.find(g => g.id == h.gameId);
                            const gameTitle = game ? game.title : 'Nieznana gra';
                            desc = `${gameTitle}: ${h.fromWh} -> ${h.toWh} (${h.qty} szt)`; val = 0; typeLbl = '<span style="color:#aaa">MM</span>';
                            actions = `<button class="btn-primary btn-sm" onclick="app.print.printTransfer(${h.id})">Drukuj</button><button class="btn-secondary btn-sm" onclick="app.modals.openTransferEdit(${h.id})">Edytuj</button>`;
                        } else if (h.type === 'REVALUATION') {
                            const game = app.data.games.find(g => g.id == h.gameId);
                            const gameTitle = game ? game.title : 'Nieznana gra';
                            desc = `${gameTitle}: Zmiana warto≈õci (Korekta)`; val = h.valDiff; typeLbl = '<span style="color:purple">KOREKTA</span>';
                            actions = `<button class="btn-delete-icon" onclick="app.logic.deleteHistoryEntry(${h.id})">X</button>`;
                        }
                        
                        if (!actions.includes('deleteHistoryEntry')) {
                             actions += `<button class="btn-delete-icon" onclick="app.logic.deleteHistoryEntry(${h.id})">X</button>`;
                        }
                        
                        tbody.innerHTML += `<tr><td>${String(h.id).slice(-6)}</td><td>${typeLbl}</td><td>${h.date}</td><td>${h.invoiceNo || '-'}</td><td>${desc}</td><td>${val.toFixed(2)} z≈Ç</td><td>${actions}</td></tr>`;
                    });
                    const searchInput = document.getElementById('histSearch');
                    if(searchInput && searchInput.value) app.ui.filterTable('historyTable', searchInput.value);
                },
                renderInventoryCheck: () => {
                    const tbody = document.querySelector('#inventoryCheckTable tbody'); tbody.innerHTML = '';
                    
                    const whSelect = document.getElementById('checkWarehouse');
                    if(whSelect && whSelect.options.length === 1) {
                        (app.data.warehouses || []).forEach(w => whSelect.innerHTML += `<option>${w}</option>`);
                    }
                    const filterWh = whSelect ? whSelect.value : "";

                    app.data.inventory.forEach(item => {
                        if(filterWh && item.warehouse !== filterWh) return;

                        const game = app.data.games.find(g => g.id == item.gameId);
                        tbody.innerHTML += `<tr><td>${game.title}</td><td>${item.warehouse}</td><td class="numeric"><strong>${item.qty}</strong></td><td><input type="number" class="inv-check-input" data-game="${item.gameId}" data-wh="${item.warehouse}" data-system="${item.qty}" oninput="app.ui.calcDiff(this)"></td><td class="numeric diff-cell diff-neutral">-</td></tr>`;
                    });
                    const searchInput = document.getElementById('checkSearch');
                    if(searchInput && searchInput.value) app.ui.filterTable('inventoryCheckTable', searchInput.value);
                },
                renderStats: () => {
                    const container = document.getElementById('statsContent');
                    
                    // --- OBLICZENIA ---
                    const stock = app.data.inventory.filter(i => i.warehouse !== COLL_WH);
                    const stockValNet = stock.reduce((s, i) => s + i.val, 0);
                    const stockValGross = stock.reduce((s, i) => s + (i.valGross || i.val*1.23), 0);
                    const stockQty = stock.reduce((s, i) => s + i.qty, 0);

                    const sales = app.data.history.filter(h => h.type === 'SALE');
                    const salesItemsForRanking = sales.flatMap(s => s.items ? s.items : [s]); // Flat list of all sold items

                    const totalRevGross = sales.reduce((s, h) => s + h.totalVal, 0); 
                    const totalRevNet = totalRevGross / 1.23;
                    const totalQtySold = salesItemsForRanking.reduce((s, i) => s + i.qty, 0);
                    
                    let totalCOGS = 0;
                    salesItemsForRanking.forEach(sItem => {
                        const inv = app.data.inventory.find(i => i.gameId == sItem.gameId);
                        const avgCost = (inv && inv.val > 0 && inv.qty > 0) ? (inv.val / inv.qty) : (sItem.price / 1.23 * 0.7); 
                        totalCOGS += (avgCost * sItem.qty);
                    });
                    const profitNet = totalRevNet - totalCOGS;
                    const margin = totalRevNet > 0 ? (profitNet / totalRevNet) * 100 : 0;

                    // 3. Zakupy
                    const receipts = app.data.history.filter(h => h.type === 'RECEIPT');
                    const totalSpendNet = receipts.reduce((s, h) => s + h.totalNet, 0);
                    const totalSpendGross = receipts.reduce((s, h) => s + h.totalGross, 0);
                    const totalBoughtQty = receipts.reduce((s, h) => s + h.items.reduce((ss, ii)=>ss+ii.qty,0), 0);

                    // 4. Potencjalny Zysk
                    let potentialProfit = 0;
                    stock.forEach(i => {
                        const gSales = salesItemsForRanking.filter(s => s.gameId == i.gameId);
                        if(gSales.length > 0) {
                            const avgSalePriceGross = gSales.reduce((s,x)=>s+x.price,0) / gSales.length;
                            const avgSalePriceNet = avgSalePriceGross / 1.23;
                            const avgBuyCostNet = i.val / i.qty;
                            if(avgSalePriceNet > avgBuyCostNet) {
                                potentialProfit += (avgSalePriceNet - avgBuyCostNet) * i.qty;
                            }
                        }
                    });

                    // 5. Kolekcja
                    const coll = app.data.inventory.filter(i => i.warehouse === COLL_WH);
                    const collVal = coll.reduce((s, i) => s + i.val, 0);
                    const collQty = coll.reduce((s, i) => s + i.qty, 0);
                    const collPubs = new Set();
                    coll.forEach(i => {
                        const g = app.data.games.find(x => x.id == i.gameId);
                        if(g && g.publisherId) collPubs.add(g.publisherId);
                    });

                    // --- HELPERY RANKING√ìW ---
                    const getTop = (arr, keyFn, valFn) => {
                        const map = {};
                        arr.forEach(item => {
                            const k = keyFn(item); if(k) map[k] = (map[k] || 0) + valFn(item);
                        });
                        return Object.entries(map).sort((a,b) => b[1] - a[1]).slice(0, 10);
                    };

                    const topPubSales = getTop(salesItemsForRanking, (sItem) => {
                        const g = app.data.games.find(x => x.id == sItem.gameId);
                        const p = g ? app.data.publishers.find(x => x.id == g.publisherId) : null;
                        return p ? p.name : 'Inne';
                    }, (sItem) => sItem.totalVal || (sItem.qty * sItem.price));

                    const topPubStock = getTop(stock, (i) => {
                        const g = app.data.games.find(x => x.id == i.gameId);
                        const p = g ? app.data.publishers.find(x => x.id == g.publisherId) : null;
                        return p ? p.name : 'Inne';
                    }, (i) => i.qty);

                    const topGamesQty = getTop(salesItemsForRanking, (sItem) => {
                        const g = app.data.games.find(x => x.id == sItem.gameId);
                        return g ? g.title : 'Nieznana';
                    }, (sItem) => sItem.qty);

                    const topGamesRevenue = getTop(salesItemsForRanking, (sItem) => {
                        const g = app.data.games.find(x => x.id == sItem.gameId);
                        return g ? g.title : 'Nieznana';
                    }, (sItem) => sItem.totalVal || (sItem.qty * sItem.price));

                    const topSuppliers = getTop(receipts, (r) => {
                        const c = app.data.clients.find(x => x.id == r.clientId);
                        return c ? c.name : 'Nieznany';
                    }, (r) => r.totalGross);

                    const renderCard = (title, val, sub, cls) => `
                        <div class="stat-card ${cls || ''}">
                            <h3>${title}</h3><div class="value">${val}</div><div class="subtext">${sub}</div>
                        </div>`;

                    const renderTable = (title, rows, col2Name="Warto≈õƒá") => `
                        <div class="ranking-card">
                            <h4 style="margin-top:0; color:var(--color-accent); border-bottom:1px solid #444; padding-bottom:5px;">${title}</h4>
                            <table class="top-table">
                                <tr><th class="col-rank">#</th><th class="col-name">Nazwa</th><th class="col-val">${col2Name}</th></tr>
                                ${rows.map((r, i) => `<tr>
                                    <td class="col-rank"><span style="color:${i===0?'gold':(i===1?'silver':(i===2?'#cd7f32':'#aaa'))}">${i+1}.</span></td>
                                    <td class="col-name">${r[0]}</td>
                                    <td class="col-val">${typeof r[1] === 'number' ? (r[1] % 1 !== 0 ? r[1].toFixed(2) : r[1]) : r[1]}</td>
                                </tr>`).join('')}
                            </table>
                        </div>`;

                    container.innerHTML = `
                        <h3 class="stats-section-title">Finanse i Magazyn (Handel)</h3>
                        <div class="stats-grid">
                            ${renderCard('Warto≈õƒá Magazynu (Netto)', stockValNet.toFixed(2) + ' z≈Ç', 'Koszt zakupu')}
                            ${renderCard('Warto≈õƒá Magazynu (Brutto)', stockValGross.toFixed(2) + ' z≈Ç', 'Cena zakupu brutto')}
                            ${renderCard('Ilo≈õƒá Gier', stockQty + ' szt', 'Na stanie (bez kolekcji)')}
                            ${renderCard('Szacowany Potencjalny Zysk', potentialProfit.toFixed(2) + ' z≈Ç', 'Przy sprzeda≈ºy ca≈Çego stanu', 'profit')}
                        </div>

                        <h3 class="stats-section-title">Sprzeda≈º (Raport)</h3>
                        <div class="stats-grid">
                            ${renderCard('Sprzeda≈º Ca≈Çkowita (Brutto)', totalRevGross.toFixed(2) + ' z≈Ç', 'Przych√≥d w kasie')}
                            ${renderCard('Sprzeda≈º Netto (Szac.)', totalRevNet.toFixed(2) + ' z≈Ç', 'Bez VAT')}
                            ${renderCard('Zysk ze Sprzeda≈ºy', profitNet.toFixed(2) + ' z≈Ç', `Mar≈ºa: ${margin.toFixed(1)}%`, 'profit')}
                            ${renderCard('Sprzedane Sztuki', totalQtySold + ' szt', `≈ör. cena: ${(totalQtySold?totalRevGross/totalQtySold:0).toFixed(2)} z≈Ç`, 'profit')}
                        </div>

                        <h3 class="stats-section-title">Zakupy i Kolekcja</h3>
                        <div class="stats-grid">
                            ${renderCard('Wydatki na Towar (Brutto)', totalSpendGross.toFixed(2) + ' z≈Ç', `Netto: ${totalSpendNet.toFixed(2)} z≈Ç`, 'cost')}
                            ${renderCard('Kupione Sztuki', totalBoughtQty + ' szt', 'Suma z faktur')}
                            ${renderCard('Warto≈õƒá Kolekcji', collVal.toFixed(2) + ' z≈Ç', 'Cena zakupu netto', 'collection')}
                            ${renderCard('Kolekcja (Ilo≈õƒá)', collQty + ' szt', `Wydawc√≥w: ${collPubs.size}`, 'collection')}
                        </div>

                        <h3 class="stats-section-title">Rankingi TOP 10</h3>
                        <div class="ranking-grid">
                            ${renderTable('Top Wydawcy (Sprzeda≈º Warto≈õƒá)', topPubSales, 'PLN')}
                            ${renderTable('Top Wydawcy (Posiadane Sztuki)', topPubStock, 'Szt.')}
                            ${renderTable('Top Gry (Sprzedane Sztuki)', topGamesQty, 'Szt.')}
                            ${renderTable('Top Gry (Przych√≥d)', topGamesRevenue, 'PLN')}
                            ${renderTable('Top Dostawcy (Wydatki Brutto)', topSuppliers, 'PLN')}
                        </div>
                    `;
                },
                calcDiff: (input) => {
                    const row = input.closest('tr'); const diffCell = row.querySelector('.diff-cell');
                    const sys = parseFloat(input.dataset.system); const act = parseFloat(input.value);
                    if (isNaN(act)) { diffCell.textContent = "-"; diffCell.className = "numeric diff-cell diff-neutral"; return; }
                    const diff = act - sys; diffCell.textContent = diff > 0 ? "+" + diff : diff;
                    if(diff > 0) diffCell.className = "numeric diff-cell diff-positive";
                    else if (diff < 0) diffCell.className = "numeric diff-cell diff-negative";
                    else diffCell.className = "numeric diff-cell diff-neutral";
                },
                updateSaleMaxQty: () => {
                    const sel = document.getElementById('saleGame');
                    if(sel.selectedIndex >= 0) {
                        const opt = sel.options[sel.selectedIndex];
                        document.getElementById('saleMaxQty').innerText = opt.dataset.qty;
                    } else {
                        document.getElementById('saleMaxQty').innerText = "0";
                    }
                },
                filterSaleSelect: () => {
                    const searchStr = document.getElementById('saleSearchInput').value.toLowerCase();
                    const sel = document.getElementById('saleGame');
                    let foundAny = false;
                    for(let i=0; i<sel.options.length; i++) {
                        const text = sel.options[i].text.toLowerCase();
                        if (text.includes(searchStr)) {
                            sel.options[i].style.display = "";
                            if (!foundAny) { sel.selectedIndex = i; foundAny = true; }
                        } else {
                            sel.options[i].style.display = "none";
                        }
                    }
                    if(!foundAny) sel.selectedIndex = -1;
                    app.ui.updateSaleMaxQty();
                },
                renderSaleItems: () => {
                    const tbody = document.querySelector('#saleItemsTable tbody');
                    tbody.innerHTML = '';
                    let total = 0;
                    app.tempSaleItems.forEach((item, idx) => {
                        total += item.totalVal;
                        tbody.innerHTML += `<tr>
                            <td>${item.title}</td>
                            <td>${item.warehouse}</td>
                            <td class="numeric">${item.qty}</td>
                            <td class="numeric">${item.price.toFixed(2)}</td>
                            <td class="numeric">${item.totalVal.toFixed(2)}</td>
                            <td><button type="button" class="btn-danger btn-sm" onclick="app.logic.removeSaleItem(${idx})">X</button></td>
                        </tr>`;
                    });
                    document.getElementById('saleTotalGross').innerText = total.toFixed(2) + ' PLN';
                },
                setupSettings: () => {
                    const createItem = (text, id, type) => {
                        const safeText = text ? text.replace(/'/g, "\\'") : ''; const idParam = id ? id : `'${safeText}'`;
                        return `<li><span>${text}</span><div><button class="btn-secondary btn-sm" onclick="app.modals.openManager('${type}', ${idParam})">Edytuj</button><button class="btn-delete-icon" onclick="app.logic.deleteManagerItem('${type}', ${idParam})">X</button></div></li>`;
                    };
                    document.getElementById('listClients').innerHTML = (app.data.clients || []).map(c => createItem(c.name, c.id, 'client')).join('');
                    document.getElementById('listPublishers').innerHTML = (app.data.publishers || []).map(p => createItem(`${p.name} (${p.code||'-'})`, p.id, 'publisher')).join('');
                    document.getElementById('listGames').innerHTML = (app.data.games || []).map(g => createItem(g.title, g.id, 'game')).join('');
                    document.getElementById('listWarehouses').innerHTML = (app.data.warehouses || []).map(w => createItem(w, null, 'warehouse')).join('');
                },
                renderBatchItems: () => {
                    const tbody = document.querySelector('#batchItemsTable tbody'); tbody.innerHTML = '';
                    let tNet = 0, tGross = 0;
                    app.data.tempBatchItems.forEach((item, idx) => {
                        tNet += item.totalNet; tGross += item.totalGross;
                        tbody.innerHTML += `<tr><td>${item.gameTitle}</td><td>${item.warehouse}</td><td>${item.qty}</td><td>${item.priceNet.toFixed(2)}</td><td>${item.vat}%</td><td>${item.priceGross.toFixed(2)}</td><td>${item.totalNet.toFixed(2)}</td><td><button class="btn-danger btn-sm" onclick="app.logic.removeBatchItem(${idx})">X</button></td></tr>`;
                    });
                    document.getElementById('batchCount').innerText = app.data.tempBatchItems.length;
                    document.getElementById('batchTotalNet').innerText = tNet.toFixed(2) + ' PLN';
                    document.getElementById('batchTotalGross').innerText = tGross.toFixed(2) + ' PLN';
                },
                populateBatchFromInvoice: (json) => {
                    document.getElementById('batchInvoiceNo').value = json.invoiceNumber || '';
                    document.getElementById('batchDate').value = json.date || '';
                    
                    if (json.sellerName) {
                        const client = app.data.clients.find(c => c.name.toLowerCase().includes(json.sellerName.toLowerCase()));
                        if (client) document.getElementById('batchClient').value = client.id;
                    }

                    app.data.tempBatchItems = [];
                    json.items.forEach(item => {
                        const g = app.data.games.find(x => x.title.toLowerCase() === item.title.toLowerCase());
                        if (g) {
                            const gross = parseFloat(item.priceGross);
                            const vat = parseInt(item.vat || 23);
                            const net = gross / (1 + vat/100);
                            app.data.tempBatchItems.push({
                                gameId: g.id, gameTitle: g.title, warehouse: DEFAULT_WH,
                                qty: parseInt(item.quantity), priceGross: gross, vat: vat, priceNet: net, totalNet: net*item.quantity, totalGross: gross*item.quantity
                            });
                        }
                    });
                    app.ui.renderBatchItems();
                    app.ui.showToast('Faktura zaczytana pomy≈õlnie!', 'success');
                }
            },

            print: {
                _generateHeader: (title) => `
                    <div class="doc-header"><div class="doc-title">${title}</div><div class="doc-meta">Data wydruku: ${new Date().toLocaleDateString()}<br>System: Magazyn Gier v3.12</div></div>
                `,
                printPZ: (id) => {
                    const h = app.data.history.find(i => i.id === id); if(!h) return;
                    const client = app.data.clients.find(c => c.id == h.clientId);
                    let html = app.print._generateHeader('Przyjƒôcie Zewnƒôtrzne (PZ)');
                    html += `<div><strong>Dostawca:</strong> ${client ? client.name : 'Unknown'} | <strong>Dokument:</strong> ${h.invoiceNo}</div>`;
                    html += `<table class="print-table"><thead><tr><th>Lp</th><th>Nazwa Towaru</th><th>Magazyn</th><th>Ilo≈õƒá</th><th>Cena Netto</th><th>Warto≈õƒá</th></tr></thead><tbody>`;
                    h.items.forEach((item, idx) => html += `<tr><td>${idx+1}</td><td>${item.gameTitle}</td><td>${item.warehouse}</td><td>${item.qty}</td><td>${item.priceNet.toFixed(2)}</td><td>${item.totalNet.toFixed(2)}</td></tr>`);
                    html += `</tbody></table><div class="summary-box">Razem Netto: <strong>${h.totalNet.toFixed(2)} PLN</strong></div>`;
                    app.print._doPrint(html);
                },
                printSale: (id) => {
                    const h = app.data.history.find(i => i.id === id); if(!h) return;
                    let html = app.print._generateHeader('Dow√≥d Sprzeda≈ºy / WZ');
                    html += `<div><strong>Klient / Zam√≥wienie:</strong> ${h.client || 'Sprzeda≈º Detaliczna'} | <strong>Data:</strong> ${h.date}</div>`;
                    html += `<table class="print-table"><thead><tr><th>Nazwa Towaru</th><th>Magazyn</th><th>Ilo≈õƒá</th><th>Cena Jedn. (Brutto)</th><th>Warto≈õƒá (Brutto)</th></tr></thead><tbody>`;
                    
                    const itemsToPrint = h.items ? h.items : [h]; // Obs≈Çuga starych i nowych wpis√≥w
                    itemsToPrint.forEach(item => {
                        const game = app.data.games.find(g => g.id == item.gameId);
                        const title = game ? game.title : 'Nieznana gra';
                        const itemVal = item.totalVal || (item.qty * item.price);
                        html += `<tr><td>${title}</td><td>${item.warehouse || '-'}</td><td>${item.qty}</td><td>${item.price.toFixed(2)}</td><td>${itemVal.toFixed(2)}</td></tr>`;
                    });

                    html += `</tbody></table>`;
                    html += `<div class="summary-box">Do Zap≈Çaty: <strong>${h.totalVal.toFixed(2)} PLN</strong></div>`;
                    app.print._doPrint(html);
                },
                printTransfer: (id) => {
                    const h = app.data.history.find(i => i.id === id); if(!h) return;
                    const game = app.data.games.find(g => g.id == h.gameId);
                    let html = app.print._generateHeader('Przesuniƒôcie Miƒôdzymagazynowe (MM)');
                    html += `<div><strong>Data:</strong> ${h.date} | <strong>Dokument:</strong> ${h.invoiceNo}</div>`;
                    html += `<table class="print-table"><thead><tr><th>Nazwa Towaru</th><th>Z Magazynu</th><th>Do Magazynu</th><th>Ilo≈õƒá</th></tr></thead><tbody>`;
                    html += `<tr><td>${game.title}</td><td>${h.fromWh}</td><td>${h.toWh}</td><td>${h.qty}</td></tr></tbody></table>`;
                    html += `<div class="print-footer"><div class="sign-box">Wyda≈Ç</div><div class="sign-box">PrzyjƒÖ≈Ç</div></div>`;
                    app.print._doPrint(html);
                },
                printAdjustmentSingle: (id) => {
                    const h = app.data.history.find(i => i.id === id); if(!h) return;
                    const game = app.data.games.find(g => g.id == h.gameId);
                    let html = app.print._generateHeader('Protok√≥≈Ç R√≥≈ºnic Inwentaryzacyjnych (Pozycja)');
                    html += `<div><strong>Data:</strong> ${h.date}</div>`;
                    html += `<table class="print-table"><thead><tr><th>Nazwa</th><th>Magazyn</th><th>R√≥≈ºnica</th><th>Warto≈õƒá Korekty</th></tr></thead><tbody>`;
                    html += `<tr><td>${game.title}</td><td>${h.warehouse}</td><td>${h.qtyDiff}</td><td>${(h.qtyDiff*h.unitVal).toFixed(2)}</td></tr></tbody></table>`;
                    app.print._doPrint(html);
                },
                printInventoryReport: () => {
                    let html = app.print._generateHeader('Raport Stanu Magazynowego');
                    html += `<table class="print-table"><thead><tr><th>Lp</th><th>Nazwa</th><th>Magazyn</th><th>Ilo≈õƒá</th><th>Warto≈õƒá</th></tr></thead><tbody>`;
                    
                    const rows = Array.from(document.querySelectorAll('#inventoryTable tbody tr')).filter(tr => tr.style.display !== 'none');
                    let idx = 1;
                    let tQ = 0;
                    let tV = 0;

                    rows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        const title = cells[1].innerText;
                        const warehouse = cells[3].innerText;
                        const qty = parseFloat(cells[4].innerText);
                        const valStr = cells[6].innerText.replace(' z≈Ç', '').replace(/\s/g, ''); 
                        const val = parseFloat(valStr) || 0;

                        html += `<tr><td>${idx++}</td><td>${title}</td><td>${warehouse}</td><td>${qty}</td><td>${val.toFixed(2)}</td></tr>`;
                        tQ += qty;
                        tV += val;
                    });
                    
                    html += `</tbody></table><div class="summary-box">Razem: ${tQ} szt | <strong>${tV.toFixed(2)} PLN</strong></div>`;
                    app.print._doPrint(html);
                },
                printInventorySheet: () => {
                    let html = app.print._generateHeader('Arkusz Spisu z Natury');
                    html += `<table class="print-table"><thead><tr><th>Nazwa</th><th>Magazyn</th><th>Ilo≈õƒá System</th><th>Ilo≈õƒá Faktyczna</th></tr></thead><tbody>`;
                    
                    const rows = Array.from(document.querySelectorAll('#inventoryCheckTable tbody tr')).filter(tr => tr.style.display !== 'none');
                    
                    rows.forEach(row => {
                        const cells = row.querySelectorAll('td');
                        const title = cells[0].innerText;
                        const warehouse = cells[1].innerText;
                        const qty = cells[2].innerText;

                        html += `<tr><td>${title}</td><td>${warehouse}</td><td>${qty}</td><td>________________</td></tr>`;
                    });

                    html += `</tbody></table>`;
                    app.print._doPrint(html);
                },
                _doPrint: (c) => { document.getElementById('printContainer').innerHTML = c; window.print(); }
            },

            modals: {
                openBatchReceipt: () => {
                    document.getElementById('batchReceiptTitle').innerText = "Nowe Przyjƒôcie Towaru (PZ)";
                    document.getElementById('batchEditId').value = ""; document.getElementById('modalBatchReceipt').showModal();
                    app.data.tempBatchItems = []; app.ui.renderBatchItems(); app.modals.populateBatchSelects();
                },
                editReceipt: (id) => {
                    const h = app.data.history.find(i => i.id === id); if(!h) return;
                    document.getElementById('batchReceiptTitle').innerText = "Edycja PZ: " + h.invoiceNo;
                    document.getElementById('batchEditId').value = h.id; document.getElementById('batchInvoiceNo').value = h.invoiceNo;
                    document.getElementById('batchDate').value = h.date; document.getElementById('batchClient').value = h.clientId;
                    app.modals.populateBatchSelects(); app.data.tempBatchItems = JSON.parse(JSON.stringify(h.items));
                    app.ui.renderBatchItems(); document.getElementById('modalBatchReceipt').showModal();
                },
                quickAdd: (type) => { app.modals.openManager(type); },
                populateBatchSelects: () => {
                    document.getElementById('batchClient').innerHTML = '<option value="" disabled selected>Wybierz...</option>' + 
                        (app.data.clients||[]).map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                    document.getElementById('batchItemGame').innerHTML = '<option value="" disabled selected>Wybierz...</option>' + 
                        (app.data.games||[]).sort((a,b)=>(a.title||'').localeCompare(b.title||'')).map(g => {
                            const pub = app.data.publishers.find(p => p.id == g.publisherId);
                            return `<option value="${g.id}">${g.title}${pub?` (${pub.name})`:''}</option>`;
                        }).join('');
                    document.getElementById('batchItemWarehouse').innerHTML = (app.data.warehouses||[]).map(w => `<option>${w}</option>`).join('');
                },
                
                openSale: () => {
                    document.getElementById('saleModalTitle').innerText = "Sprzeda≈º (Koszyk)"; 
                    document.getElementById('saleEditId').value = "";
                    document.getElementById('formSale').reset(); 
                    document.getElementById('saleDate').valueAsDate = new Date();
                    document.getElementById('saleSearchInput').value = "";
                    app.tempSaleItems = [];
                    app.ui.renderSaleItems();
                    app.modals.populateSaleSelect(); 
                    app.ui.updateSaleMaxQty(); 
                    document.getElementById('modalSale').showModal();
                },
                editSale: (id) => {
                    const h = app.data.history.find(i => i.id === id); if(!h) return;
                    document.getElementById('saleModalTitle').innerText = "Edycja Paragonu"; 
                    document.getElementById('saleEditId').value = h.id;
                    document.getElementById('saleDate').value = h.date; 
                    document.getElementById('saleClient').value = h.client || '';
                    document.getElementById('saleSearchInput').value = "";
                    
                    if (h.items) {
                        app.tempSaleItems = JSON.parse(JSON.stringify(h.items));
                    } else {
                        // Obs≈Çuga starych wpis√≥w
                        const g = app.data.games.find(x => x.id == h.gameId);
                        app.tempSaleItems = [{
                            gameId: h.gameId, title: g ? g.title : 'Nieznana', warehouse: h.warehouse || DEFAULT_WH,
                            qty: h.qty, price: h.price, totalVal: h.totalVal
                        }];
                    }
                    
                    app.ui.renderSaleItems();
                    app.modals.populateSaleSelect(); 
                    document.getElementById('saleMaxQty').innerText = "(Edycja)"; 
                    document.getElementById('modalSale').showModal();
                },
                populateSaleSelect: () => {
                    const sel = document.getElementById('saleGame');
                    const games = app.data.inventory.filter(i => i.qty > 0 || i.warehouse === DEFAULT_WH);
                    sel.innerHTML = games.map(i => {
                        const g = app.data.games.find(x => x.id == i.gameId);
                        return g ? `<option value="${g.id}" data-wh="${i.warehouse}" data-qty="${i.qty}">${g.title} (${i.warehouse}) - Stan: ${i.qty}</option>` : '';
                    }).join('');
                    // Od≈õwie≈º wyb√≥r pierwszego
                    app.ui.filterSaleSelect();
                },
                openSalePrefill: (id) => { 
                    app.modals.openSale(); 
                    const sel = document.getElementById('saleGame');
                    let found = false;
                    for(let i=0; i<sel.options.length; i++) {
                        if(sel.options[i].value == id) { sel.selectedIndex = i; found = true; break; }
                    }
                    if(found) app.ui.updateSaleMaxQty();
                },
                
                openTransfer: (gameId, currentWh) => {
                    const g = app.data.games.find(x => x.id == gameId);
                    const i = app.data.inventory.find(x => x.gameId == gameId && x.warehouse == currentWh);
                    document.getElementById('transferGameId').value = gameId; document.getElementById('transferEditId').value = "";
                    document.getElementById('transferGameTitle').innerText = g.title; document.getElementById('transferFromWh').value = currentWh;
                    document.getElementById('transferToWh').innerHTML = app.data.warehouses.filter(w=>w!==currentWh).map(w=>`<option>${w}</option>`).join('');
                    document.getElementById('transferQty').value = 1; document.getElementById('transferMaxQty').innerText = i ? i.qty : 0;
                    document.getElementById('modalTransfer').showModal();
                },
                openTransferEdit: (id) => {
                    const h = app.data.history.find(x => x.id == id); if(!h) return;
                    const g = app.data.games.find(x => x.id == h.gameId);
                    document.getElementById('transferTitle').innerText = "Edycja MM";
                    document.getElementById('transferGameId').value = h.gameId; document.getElementById('transferEditId').value = h.id;
                    document.getElementById('transferGameTitle').innerText = g.title; document.getElementById('transferFromWh').value = h.fromWh;
                    document.getElementById('transferToWh').innerHTML = `<option selected>${h.toWh}</option>`; // Simplify edit
                    document.getElementById('transferQty').value = h.qty; document.getElementById('transferMaxQty').innerText = "(Edycja)";
                    document.getElementById('modalTransfer').showModal();
                },
                openAdjustment: (id) => {
                    const h = app.data.history.find(x => x.id == id); if(!h) return;
                    const g = app.data.games.find(x => x.id == h.gameId);
                    document.getElementById('adjEditId').value = h.id; document.getElementById('adjGameTitle').innerText = g.title;
                    document.getElementById('adjWarehouse').innerText = h.warehouse; document.getElementById('adjQtyDiff').value = h.qtyDiff;
                    document.getElementById('modalAdjustment').showModal();
                },
                openManager: (type, id=null, prefillName=null) => {
                    document.getElementById('managerType').value = type; document.getElementById('managerId').value = id||'';
                    document.getElementById('managerTitle').innerText = id ? 'Edytuj' : 'Dodaj';
                    document.getElementById('managerName').value = prefillName || '';
                    document.getElementById('managerPublisherCodeGroup').style.display = 'none';
                    document.getElementById('managerGamePublisherGroup').style.display = 'none';
                    document.getElementById('managerExistingGroup').style.display = 'none';

                    if (!id && ['client', 'game', 'publisher'].includes(type)) {
                        document.getElementById('managerExistingGroup').style.display = 'block';
                        const sel = document.getElementById('managerExistingSelect');
                        let options = '<option value="NEW" selected>--- Utw√≥rz nowy (wg nazwy poni≈ºej) ---</option>';
                        let source = [];
                        if(type === 'client') source = app.data.clients;
                        if(type === 'game') source = app.data.games;
                        if(type === 'publisher') source = app.data.publishers;
                        
                        source.sort((a,b)=>(a.name||a.title).localeCompare(b.name||b.title)).forEach(item => {
                            options += `<option value="${item.id}">${item.name || item.title}</option>`;
                        });
                        sel.innerHTML = options;
                        app.ui.toggleManagerInput(); 
                    }

                    if (type === 'client' && id) document.getElementById('managerName').value = app.data.clients.find(c=>c.id==id).name;
                    if (type === 'warehouse' && id) document.getElementById('managerName').value = id;
                    if (type === 'publisher') {
                        document.getElementById('managerPublisherCodeGroup').style.display = 'block';
                        if(id) { const p = app.data.publishers.find(x=>x.id==id); document.getElementById('managerName').value=p.name; document.getElementById('managerPublisherCode').value=p.code; }
                    }
                    if (type === 'game') {
                        document.getElementById('managerGamePublisherGroup').style.display = 'block';
                        document.getElementById('managerGamePublisher').innerHTML = app.data.publishers.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
                        if(id) { const g = app.data.games.find(x=>x.id==id); document.getElementById('managerName').value=g.title; document.getElementById('managerGamePublisher').value=g.publisherId; }
                    }
                    document.getElementById('modalManager').showModal();
                },
                openItemHistory: (id) => {
                    const g = app.data.games.find(x => x.id === id);
                    document.getElementById('itemHistoryTitle').innerText = g ? g.title : 'Nieznany';
                    
                    document.getElementById('itemHistoryGameId').value = id;
                    const pubSelect = document.getElementById('itemHistoryPublisher');
                    pubSelect.innerHTML = app.data.publishers.sort((a,b)=>a.name.localeCompare(b.name)).map(p => 
                        `<option value="${p.id}" ${g && g.publisherId == p.id ? 'selected' : ''}>${p.name}</option>`
                    ).join('');

                    const tbody = document.querySelector('#itemHistoryTable tbody'); tbody.innerHTML = '';
                    [...(app.data.history||[])].sort((a,b)=>new Date(a.date)-new Date(b.date)).forEach(h => {
                        let inc=0, out=0, prc=0, wh='', doc='', match=false;
                        if(h.type==='RECEIPT') { const i=h.items.find(x=>x.gameId==id); if(i){ match=true; inc=i.qty; prc=i.priceNet; wh=i.warehouse; doc='PZ'; } }
                        else if(h.type==='SALE') { const i=h.items?h.items.find(x=>x.gameId==id):(h.gameId==id?h:null); if(i){ match=true; out=i.qty; prc=i.price; wh=i.warehouse||'-'; doc='WZ'; } }
                        else if(h.gameId==id) { match=true; wh=h.warehouse||(h.fromWh+'->'+h.toWh); doc=h.type; if(h.qty) out=h.qty; if(h.qtyDiff) { if(h.qtyDiff>0) inc=h.qtyDiff; else out=Math.abs(h.qtyDiff); } }
                        if(h.type === 'REVALUATION' && h.gameId === id) { match=true; doc='KOREKTA'; wh=h.warehouse; prc = h.valDiff; } 

                        if(match) {
                            let typeLbl = h.type;
                            if(h.type === 'REVALUATION') typeLbl = '<span style="color:purple">WARTO≈öƒÜ</span>';
                            
                            tbody.innerHTML += `<tr><td>${h.date}</td><td>${doc}</td><td>${typeLbl}</td><td style="color:green">${inc||'-'}</td><td style="color:red">${out||'-'}</td><td>${prc.toFixed(2)}</td><td>${wh}</td></tr>`;
                        }
                    });
                    document.getElementById('modalItemHistory').showModal();
                }
            },

            io: {
                save: () => localStorage.setItem(STORAGE_KEY, JSON.stringify(app.data)),
                load: () => {
                    const str = localStorage.getItem(STORAGE_KEY);
                    if(str) {
                        app.data = JSON.parse(str);
                        if(!app.data.clients) app.data.clients=[]; if(!app.data.games) app.data.games=[];
                        if(!app.data.history) app.data.history=[]; if(!app.data.inventory) app.data.inventory=[];
                    } else {
                        app.data.warehouses = [DEFAULT_WH, 'Sklep', COLL_WH];
                        app.data.clients = [{id:1, name:'Rebel'}]; app.data.publishers = [{id:1, name:'Rebel', code:'REB'}];
                        app.data.games = [{id:101, title:'Dixit', publisherId:1}];
                    }
                },
                exportData: () => {
                    const blob = new Blob([JSON.stringify(app.data)], {type: 'application/json'});
                    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
                    a.download = `backup_${new Date().toISOString().slice(0,10)}.json`; a.click();
                },
                importData: (input) => {
                    const reader = new FileReader();
                    reader.onload = (e) => { app.data = JSON.parse(e.target.result); app.io.save(); location.reload(); };
                    reader.readAsText(input.files[0]);
                },
                importInvoice: (input) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const json = JSON.parse(e.target.result);
                            
                            app.wizard.invoiceData = json;
                            app.wizard.queue = [];

                            if(json.sellerName) {
                                const client = app.data.clients.find(c => c.name.toLowerCase().includes(json.sellerName.toLowerCase()));
                                if (!client) app.wizard.queue.push({ type: 'client', name: json.sellerName });
                            }

                            if(json.items && Array.isArray(json.items)) {
                                json.items.forEach(item => {
                                    const g = app.data.games.find(x => x.title.toLowerCase() === item.title.toLowerCase());
                                    if (!g) app.wizard.queue.push({ type: 'game', name: item.title });
                                });
                            }

                            if (app.wizard.queue.length > 0) {
                                app.wizard.active = true;
                                document.getElementById('modalBatchReceipt').close(); 
                                alert(`Wykryto ${app.wizard.queue.length} nowych pozycji (sprzedawca/gry). Uruchamiam kreatora dodawania.`);
                                app.logic.processNextWizardStep();
                            } else {
                                app.ui.populateBatchFromInvoice(json);
                            }

                        } catch(e) { 
                            console.error(e);
                            alert("B≈ÇƒÖd przetwarzania pliku JSON: " + e.message); 
                        }
                    };
                    reader.readAsText(input.files[0]);
                },
                importPublishers: (input) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const json = JSON.parse(e.target.result);
                            let count = 0;
                            json.forEach(item => {
                                const exists = app.data.publishers.find(p => p.name.toLowerCase() === item.nazwa.toLowerCase());
                                if (!exists) {
                                    app.data.publishers.push({
                                        id: Date.now() + Math.floor(Math.random() * 1000),
                                        name: item.nazwa,
                                        code: item.kod || ''
                                    });
                                    count++;
                                }
                            });
                            app.io.save();
                            app.ui.setupSettings();
                            alert(`Zaimportowano ${count} nowych wydawc√≥w.`);
                        } catch (err) { alert("B≈ÇƒÖd importu: " + err.message); }
                        input.value = '';
                    };
                    reader.readAsText(input.files[0]);
                },
                importGames: (input) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const json = JSON.parse(e.target.result);
                            let count = 0;
                            json.forEach(item => {
                                let pubId = 0;
                                if (item.wydawca) {
                                    let pub = app.data.publishers.find(p => p.name.toLowerCase() === item.wydawca.toLowerCase());
                                    if (!pub) {
                                        pub = { id: Date.now() + Math.floor(Math.random() * 1000), name: item.wydawca, code: '' };
                                        app.data.publishers.push(pub);
                                    }
                                    pubId = pub.id;
                                }
                                const exists = app.data.games.find(g => g.title.toLowerCase() === item.tytul.toLowerCase());
                                if (!exists) {
                                    app.data.games.push({
                                        id: Date.now() + Math.floor(Math.random() * 10000),
                                        title: item.tytul,
                                        publisherId: pubId
                                    });
                                    count++;
                                }
                            });
                            app.io.save();
                            app.ui.setupSettings();
                            alert(`Zaimportowano ${count} nowych gier.`);
                        } catch (err) { alert("B≈ÇƒÖd importu: " + err.message); }
                        input.value = '';
                    };
                    reader.readAsText(input.files[0]);
                }
            }
        };

        app.init();
        window.app = app;

        // Funkcja komunikacji z Agentem AI
        async function askAgent(textData, mode = 'general') {
            try {
                const response = await fetch('/.netlify/functions/agent', {
                    method: 'POST',
                    body: JSON.stringify({ text: textData, mode: mode })
                });
                const result = await response.json();
                return result.answer;
            } catch (error) {
                console.error("B≈ÇƒÖd Agenta:", error);
                return "B≈ÇƒÖd komunikacji z AI";
            }
        }

        // --- INTEGRACJA ALLEGRO ---
        const ALLEGRO_CLIENT_ID = '8f33f9c35dc94b1baef53092b74d8206'; 
        let allegroToken = localStorage.getItem('allegro_token');

        // Sprawdzenie po≈ÇƒÖczenia przy starcie
        if (allegroToken) {
            const statusEl = document.getElementById('allegro-status');
            if(statusEl) {
                statusEl.innerText = "Status: ‚úÖ Po≈ÇƒÖczono";
                document.getElementById('btn-allegro-sync').style.display = 'inline-block';
            }
        }

        async function loginToAllegro() {
            const statusEl = document.getElementById('allegro-status');
            if(statusEl) statusEl.innerText = "Status: ≈ÅƒÖczenie...";

            try {
                const response = await fetch('/.netlify/functions/allegro-auth', { method: 'POST' });
                const data = await response.json();

                if (data.user_code) {
                    alert(`TW√ìJ KOD: ${data.user_code}\nWpisz go na stronie Allegro, kt√≥ra siƒô teraz otworzy.`);
                    window.open(data.verification_uri, '_blank');
                    if(statusEl) statusEl.innerHTML = `Wpisz kod <b>${data.user_code}</b> na Allegro.`;
                    checkAuthorization(data.device_code);
                }
            } catch (err) {
                if(statusEl) statusEl.innerText = "B≈ÇƒÖd po≈ÇƒÖczenia.";
            }
        }

        async function checkAuthorization(deviceCode) {
            const interval = setInterval(async () => {
                const res = await fetch('/.netlify/functions/allegro-auth', {
                    method: 'PUT',
                    body: JSON.stringify({ deviceCode })
                });
                if (res.ok) {
                    const data = await res.json();
                    if (data.access_token) {
                        localStorage.setItem('allegro_token', data.access_token);
                        document.getElementById('allegro-status').innerText = "Status: ‚úÖ Po≈ÇƒÖczono";
                        document.getElementById('btn-allegro-sync').style.display = 'inline-block';
                        clearInterval(interval);
                    }
                }
            }, 5000);
        }

        async function syncAllegroOrders() {
    const token = localStorage.getItem('allegro_token');
    const statusEl = document.getElementById('allegro-status');
    if(statusEl) statusEl.innerText = "Status: Pobieranie i analiza zam√≥wie≈Ñ przez AI...";

    try {
        // 1. Pobieramy dane z Allegro
        const response = await fetch('/.netlify/functions/allegro-sync', {
            headers: { 'Authorization': token }
        });
        const data = await response.json();
        
        // 2. Wysy≈Çamy do naszego Agenta AI
        const aiResponse = await askAgent(JSON.stringify(data), 'allegro_sync');
        
        // 3. Przetwarzamy odpowied≈∫ od AI (zamieniamy tekst na obiekt JSON)
        let soldGames = [];
        try {
            soldGames = JSON.parse(aiResponse);
        } catch (e) {
            console.error("AI nie zwr√≥ci≈Ço poprawnego JSONa:", aiResponse);
            alert("B≈ÇƒÖd: AI nie zwr√≥ci≈Ço danych w formacie czytelnym dla systemu.");
            if(statusEl) statusEl.innerText = "Status: B≈ÇƒÖd parsowania danych";
            return;
        }

        // 4. LOGIKA ODEJMOWANIA ZE STANU MAGAZYNOWEGO
        let updateMessage = "Agent AI przetworzy≈Ç zam√≥wienia:\n\n";
        let tableRows = document.querySelectorAll('#inventory-body tr'); // Szukamy wierszy w Twojej tabeli

        soldGames.forEach(soldGame => {
            let gameFound = false;
            
            tableRows.forEach(row => {
                let titleCell = row.cells[0].innerText.toLowerCase(); // Pierwsza kolumna to Tytu≈Ç
                let stockCell = row.cells[2]; // Trzecia kolumna to Ilo≈õƒá (indeks 2)
                
                // Szukamy dopasowania (czƒô≈õciowego) w nazwie
                if (titleCell.includes(soldGame.tytul.toLowerCase())) {
                    let currentStock = parseInt(stockCell.innerText) || 0;
                    let newStock = currentStock - soldGame.ilosc;
                    
                    // Zabezpieczenie przed ujemnym stanem
                    stockCell.innerText = newStock < 0 ? 0 : newStock; 
                    
                    updateMessage += `‚úÖ ${soldGame.tytul}: Zmniejszono stan o ${soldGame.ilosc} szt.\n`;
                    gameFound = true;
                }
            });

            if (!gameFound) {
                updateMessage += `‚ùå ${soldGame.tytul}: Nie znaleziono takiej gry w tabeli!\n`;
            }
        });

        // 5. Powiadomienie o sukcesie
        alert(updateMessage);
        if(statusEl) statusEl.innerText = "Status: ‚úÖ Synchronizacja i aktualizacja zako≈Ñczona";
        
        // Zapisz nowy stan do LocalStorage, ≈ºeby nie zniknƒÖ≈Ç po od≈õwie≈ºeniu
        saveData(); 

    } catch (err) {
        console.error(err);
        if(statusEl) statusEl.innerText = "B≈ÇƒÖd komunikacji z serwerem.";
    }
}
    </script>
</body>
</html>
